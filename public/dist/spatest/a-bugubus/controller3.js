var app=angular.module("app"),errorFn=function(){console.log("你好，数据请求失败")},floatObj=function(){function isInteger(obj){return Math.floor(obj)===obj}function toInteger(floatNum){var ret={times:1,num:0};if(isInteger(floatNum))return ret.num=floatNum,ret;var strfi=floatNum+"",dotPos=strfi.indexOf("."),len=strfi.substr(dotPos+1).length,times=Math.pow(10,len),intNum=parseInt(floatNum*times+.5,10);return ret.times=times,ret.num=intNum,ret}function operation(a,b,digits,op){var o1=toInteger(a),o2=toInteger(b),n1=o1.num,n2=o2.num,t1=o1.times,t2=o2.times,max=t1>t2?t1:t2,result=null;switch(op){case"add":return result=t1===t2?n1+n2:t1>t2?n1+n2*(t1/t2):n1*(t2/t1)+n2,result/max;case"subtract":return result=t1===t2?n1-n2:t1>t2?n1-n2*(t1/t2):n1*(t2/t1)-n2,result/max;case"multiply":return result=n1*n2/(t1*t2);case"divide":return result=n1/n2*(t2/t1)}}function add(a,b,digits){return operation(a,b,digits,"add")}function subtract(a,b,digits){return operation(a,b,digits,"subtract")}function multiply(a,b,digits){return operation(a,b,digits,"multiply")}function divide(a,b,digits){return operation(a,b,digits,"divide")}return{add:add,subtract:subtract,multiply:multiply,divide:divide}}();app.controller("City_select",function($rootScope,$scope,$state,$timeout,$interval,$myLocationService,$myHttpService,$ionicSlideBoxDelegate,$ionicActionSheet,$selectCity,$filter){function slideImage(){$rootScope.recommendProducts2&&$rootScope.recommendProducts2.length>0&&($rootScope.recommendProducts2Index=$rootScope.recommendProducts2Index===$rootScope.recommendProducts2.length-1?0:$rootScope.recommendProducts2Index+1,$rootScope.slideNumber=$ionicSlideBoxDelegate.$getByHandle("adBanner").currentIndex(),$rootScope.slideNumber+1!=$rootScope.recommendProducts2Index&&0!=$rootScope.recommendProducts2Index?($rootScope.recommendProducts2Index=$rootScope.slideNumber,$ionicSlideBoxDelegate.$getByHandle("adBanner").slide($rootScope.recommendProducts2Index)):$ionicSlideBoxDelegate.$getByHandle("adBanner").slide($rootScope.recommendProducts2Index))}function unique2(array,prop){for(var val,type,n={},r=[],i=(array.length,0);i<array.length;i++)val=array[i][prop],type=typeof val,n[val]?n[val].indexOf(type)<0&&(n[val].push(type),r.push(val)):(n[val]=[type],r.push(val));return r}if(null==sessionStorage.getItem("recommendImgCount")){var recommendImgCount=1;$rootScope.recommendProducts2=[];var slideImageTimer=null}else var recommendImgCount=sessionStorage.getItem("recommendImgCount");if($scope.showDefaultImg=!0,$scope.dataContainer={input:"",btnDisabled:!0},1==recommendImgCount?(sessionStorage.setItem("recommendImgCount",2),$myHttpService.postNoLoad("api/product/queryRecommendProductList",{},function(data){$rootScope.recommendProducts2=data.products,0==$rootScope.recommendProducts2.length?$timeout(function(){$scope.showDefaultImg=!0,$ionicSlideBoxDelegate.update()},500):($scope.showDefaultImg=!1,$ionicSlideBoxDelegate.update(),$timeout(function(){$ionicSlideBoxDelegate.next()},1e3))},errorFn)):(clearTimeout(slideImageTimer),$rootScope.recommendProducts2 instanceof Array&&$rootScope.recommendProducts2.length>0&&($scope.showDefaultImg=!1)),$rootScope.recommendProducts2Index=0,slideImageTimer=$interval(function(){slideImage()},3e3),$scope.$on("$destroy",function(){$interval.cancel(slideImageTimer)}),$scope.$on("$ionicView.beforeLeave",function(){clearTimeout(slideImageTimer)}),$scope.recommendProductsDetail=function(item){var data={productid:item.productid};$state.go("tabs",{data:JSON.stringify(data)},{reload:!0})},1==recommendImgCount?$selectCity.getCity(function(data){$scope.positionCity=data;var pattern=/(贵阳.*|遵义.*|六盘水.*|毕节.*|黔南.*|黔东南.*|黔西南.*|铜仁.*|安顺.*)/g,re=pattern.test($scope.positionCity);re?(null==sessionStorage.getItem("search_city")?($scope.positionCity="贵阳",$rootScope.cityssss=$scope.positionCity):($scope.positionCity=sessionStorage.getItem("search_city"),$rootScope.cityssss=$scope.positionCity),null!=sessionStorage.getItem("search_input")&&($scope.dataContainer.input=sessionStorage.getItem("search_input"),$scope.dataContainer.btnDisabled=!1)):($scope.positionCity="贵阳",$rootScope.cityssss=$scope.positionCity)}):(null==sessionStorage.getItem("search_city")?($scope.positionCity="贵阳",$rootScope.cityssss=$scope.positionCity):($scope.positionCity=sessionStorage.getItem("search_city"),$rootScope.cityssss=$scope.positionCity),null!=sessionStorage.getItem("search_input")&&($scope.dataContainer.input=sessionStorage.getItem("search_input"),$scope.dataContainer.btnDisabled=!1)),1==recommendImgCount?($rootScope.tempsz=[],$myHttpService.postNoLoad("api/product/queryBuslineRegion",{},function(data){$scope.citysz=unique2(data.regions,"regionName");for(var i=0,len=$scope.citysz.length;len>i;i++){var obj={text:$scope.citysz[i]};$rootScope.tempsz.push(obj)}$scope.show=function(){$ionicActionSheet.show({buttons:$rootScope.tempsz,titleText:"请选择城市",cancel:function(){},buttonClicked:function(index,element){return $scope.cityssss=element.text.toString(),!0}})}},errorFn)):$scope.show=function(){$ionicActionSheet.show({buttons:$rootScope.tempsz,titleText:"请选择城市",cancel:function(){},buttonClicked:function(index,element){return $scope.cityssss=element.text.toString(),!0}})},null!=sessionStorage.getItem("jqztc_search_time"))var tempTime=sessionStorage.getItem("jqztc_search_time");else var tempTime=new Date;$scope.goDate={title:"选择日期",time:tempTime},$scope.detectionDate=function(){var compareTime=(new Date).getTime()+5184e6,selectTime=$scope.goDate.time.getTime();selectTime>compareTime&&(layer.open({content:"不在预售范围内，预售期仅为60天，请重新选择",btn:"确定"}),$scope.goDate.time=new Date)},$scope.btnCheck=function(){$scope.dataContainer.btnDisabled=$scope.dataContainer.input?!1:!0},$scope.goTabs=function(){var data={city:$scope.cityssss,input:$scope.dataContainer.input.trim(),date:$filter("date")($scope.goDate.time,"yyyy-MM-dd")};sessionStorage.setItem("jqztc_search_time",data.date),sessionStorage.setItem("search_city",$scope.cityssss),sessionStorage.setItem("search_input",$scope.dataContainer.input.trim()),$state.go("tabs",{data:JSON.stringify(data)},{reload:!0})}}).controller("Tabs",function($rootScope,$scope,$state,$timeout,$myHttpService){$scope.ticketsInfo=[],$scope.commentsInfo=[],$scope.noticeInfo="";var paramsData=JSON.parse($state.params.data);if(null!=paramsData)if(paramsData.hasOwnProperty("productid")){sessionStorage.setItem("questUrlType","0"),sessionStorage.setItem("tabsParamsDataProductid",paramsData.productid),console.log("1111");var requestData={productid:paramsData.productid};$myHttpService.post("api/product/queryRecommendProduct",requestData,function(data){console.log(data),$scope.ticketsInfo=data.products,0!=data.products.length?$scope.noticeInfo=data.products[0].productinfo:layer.open({content:"当前选择的推荐主题路线，今日已售完",btn:"确定"})},errorFn)}else{sessionStorage.setItem("questUrlType","1"),sessionStorage.setItem("tabsParamsDataInput",paramsData.input),sessionStorage.setItem("tabsParamsDataDate",paramsData.date),sessionStorage.setItem("tabsParamsDataCity",paramsData.city);var requestData={keyword:paramsData.input,departDate:paramsData.date,region:paramsData.city};$myHttpService.post("api/product/queryProductList",requestData,function(data){console.log(data),$scope.ticketsInfo=data.products,0!=data.products.length?$scope.noticeInfo=data.products[0].productinfo:layer.open({content:"当前班次，今日已售完，请选择往后日期",btn:"确定"})},errorFn)}else if("0"==sessionStorage.getItem("questUrlType")){var requestData={productid:sessionStorage.getItem("tabsParamsDataProductid")};$myHttpService.post("api/product/queryRecommendProduct",requestData,function(data){console.log(data),$scope.ticketsInfo=data.products,0!=data.products.length?$scope.noticeInfo=data.products[0].productinfo:layer.open({content:"当前选择的推荐主题路线，今日已售完",btn:"确定"})},errorFn)}else if("1"==sessionStorage.getItem("questUrlType")){var requestData={keyword:sessionStorage.getItem("tabsParamsDataInput"),departDate:sessionStorage.getItem("tabsParamsDataDate"),region:sessionStorage.getItem("tabsParamsDataCity")};console.log(requestData),$myHttpService.post("api/product/queryProductList",requestData,function(data){console.log(data),$scope.ticketsInfo=data.products,0!=data.products.length?$scope.noticeInfo=data.products[0].productinfo:layer.open({content:"当前班次，今日已售完，请选择往后日期",btn:"确定"})},errorFn)}else $state.go("search");$scope.purchase=function(item){console.log("购买按钮传递的参数："),console.log(item),$state.go("order_confirm_pay",{data:JSON.stringify(item)})};var check_click_count=0,check_click_count2=0;$scope.tab_road=function(){1>check_click_count&&console.log("road"),check_click_count++},$scope.tab_comment=function(){1>check_click_count2&&console.log("comment"),check_click_count2++},$scope.tab_notice=function(){console.log("notice")},$scope.doRefreshRoad=function(){if(null!=paramsData){if("0"==sessionStorage.getItem("questUrlType")){console.log("1111");var requestData={productid:paramsData.productid};$myHttpService.postNoLoad("api/product/queryRecommendProduct",requestData,function(data){console.log(data),$scope.ticketsInfo=data.products,$scope.$broadcast("scroll.refreshComplete"),layer.open({content:"刷新成功",skin:"msg",time:1})},function(){$scope.$broadcast("scroll.refreshComplete")})}else if("1"==sessionStorage.getItem("questUrlType")){var requestData={keyword:paramsData.input,departDate:paramsData.date,region:paramsData.city};console.log(requestData),$myHttpService.postNoLoad("api/product/queryProductList",requestData,function(data){console.log(data),$scope.ticketsInfo=data.products,$scope.$broadcast("scroll.refreshComplete"),layer.open({content:"刷新成功",skin:"msg",time:1})},function(){$scope.$broadcast("scroll.refreshComplete")})}}else if("0"==sessionStorage.getItem("questUrlType")){var requestData={productid:sessionStorage.getItem("tabsParamsDataProductid")};$myHttpService.postNoLoad("api/product/queryRecommendProduct",requestData,function(data){console.log(data),$scope.ticketsInfo=data.products,$scope.$broadcast("scroll.refreshComplete"),layer.open({content:"刷新成功",skin:"msg",time:1})},function(){$scope.$broadcast("scroll.refreshComplete")})}else if("1"==sessionStorage.getItem("questUrlType")){var requestData={keyword:sessionStorage.getItem("tabsParamsDataInput"),departDate:sessionStorage.getItem("tabsParamsDataDate"),region:sessionStorage.getItem("tabsParamsDataCity")};console.log(requestData),$myHttpService.postNoLoad("api/product/queryProductList",requestData,function(data){console.log(data),$scope.ticketsInfo=data.products,$scope.$broadcast("scroll.refreshComplete"),layer.open({content:"刷新成功",skin:"msg",time:1})},function(){$scope.$broadcast("scroll.refreshComplete")})}},$scope.pageCount=1,$scope.isNoComment=!1,$scope.doRefreshComment=function(){if(0==$scope.ticketsInfo.length)return $scope.isNoComment=!0,void $scope.$broadcast("scroll.refreshComplete");var viewaddress=$scope.ticketsInfo[0].viewaddress;$scope.pageCount=1,$myHttpService.postNoLoad("api/product/queryProductHieList",{viewaddress:viewaddress,offset:"0",pagesize:"10"},function(data){console.log("评论刷新"),$scope.commentsInfo=data.viewOrders,console.log(data),$scope.$broadcast("scroll.refreshComplete"),0==$scope.commentsInfo.length?$scope.isNoComment=!0:layer.open({content:"刷新成功",skin:"msg",time:1})})},$scope.hasmore=!0;var run=!1;$scope.loadMoreComment=function(){if(0==$scope.ticketsInfo.length)return void($scope.isNoComment=!0);var viewaddress=$scope.ticketsInfo[0].viewaddress,offset=10*($scope.pageCount-1),requestData={viewaddress:viewaddress,offset:offset,pagesize:"10"};run||(run=!0,$myHttpService.post("api/product/queryProductHieList",requestData,function(data){data.viewOrders.length<10&&($scope.hasmore=!1),$scope.pageCount++,console.log("计数： "+$scope.pageCount),run=!1,console.log("评论加载"),$scope.commentsInfo=$scope.commentsInfo.concat(data.viewOrders),console.log($scope.commentsInfo),$scope.$broadcast("scroll.infiniteScrollComplete"),0==$scope.commentsInfo.length&&($scope.isNoComment=!0)}))},$scope.max=5,$scope.readonly=!0,$scope.onHover=function(){},$scope.onLeave=function(){}}).controller("order_confirm_pay",function($rootScope,$filter,$scope,$state,$myHttpService,$interval,$ionicModal){if(null==JSON.parse($state.params.data))return void window.history.go(-2);$scope.dataContainer={phone:"",verificationCode:"",coupon:!1,count:1},$rootScope.customerPhone="18302505304";var paramsData=JSON.parse($state.params.data);$scope.ticketInfo=paramsData,console.log("ZW：传递到 order_confirm_pay 页面的全部车票信息"),console.log($scope.ticketInfo),$scope.leftTickets=$scope.ticketInfo.leftTickets,$scope.checkPhoneState=!1,$scope.verificationCodeBtnDisabled=!0,$scope.verificationCodeInputDisabled=!0,$scope.payBtnDisabled=!0,$scope.countdownTxtShow=!1,$scope.couponBtnState=!1,$scope.couponTxTShow=!1,$scope.checkPhone=function(){if(void 0!=$scope.dataContainer.phone)if(11==$scope.dataContainer.phone.length){var phone=$scope.dataContainer.phone.toString();if(!/^1(3|4|5|7|8)\d{9}$/.test(phone))return layer.msg("输入的手机号码有误"),$scope.verificationCodeBtnDisabled=!0,$scope.payBtnDisabled=!0,!1;$scope.verificationCodeBtnDisabled=!1}else $scope.verificationCodeBtnDisabled=!0,$scope.payBtnDisabled=!0};var defaultCountdown=60;$scope.countdownTime=defaultCountdown;var stopCountdownTime;$scope.fight=function(){$scope.countdownTxtShow=!0,angular.isDefined(stopCountdownTime)||(stopCountdownTime=$interval(function(){$scope.countdownTime>0?$scope.countdownTime=$scope.countdownTime-1:($scope.stopFight(),$scope.countdownTxtShow=!1,$scope.verificationCodeBtnDisabled=!1,$scope.resetFight())},1e3))},$scope.stopFight=function(){angular.isDefined(stopCountdownTime)&&($interval.cancel(stopCountdownTime),stopCountdownTime=void 0)},$scope.resetFight=function(){$scope.countdownTime=defaultCountdown},$scope.$on("$destroy",function(){$scope.stopFight()}),$scope.countdown=function(){$scope.verificationCodeBtnDisabled=!0,console.log("电话号码："+$scope.dataContainer.phone),$scope.fight();var departDate=$filter("date")($scope.ticketInfo.departdate,"yyyy-MM-dd"),bsids=$scope.ticketInfo.golinename+"&"+departDate+"&"+$scope.ticketInfo.departtime,checkcode=parseInt($scope.dataContainer.phone)%parseInt($scope.dataContainer.phone.substring(1,4)),requestData={phone:$scope.dataContainer.phone,servicename:"UserBuyViewTicket",checkcode:checkcode.toString(),bsids:bsids};console.log("验证码请求参数打印："),console.log(requestData),$myHttpService.postNoLoad("api/utils/sendCheckAuthcode",requestData,function(data){console.log(data)})},$scope.floatObj=floatObj,1==$scope.ticketInfo.haveTicket?(console.log("有车票时"),$scope.scenicSpotTicketPrice=$scope.ticketInfo.viewPrices[0].couponPrice,$scope.scenicSpotTicketPriceID=$scope.ticketInfo.viewPrices[0].viewPriceId,console.log($scope.scenicSpotTicketPriceID),$scope.price=$scope.floatObj.add($scope.ticketInfo.productPrice,$scope.scenicSpotTicketPrice,2),$scope.price2=$scope.ticketInfo.productPrice,$scope.price3=$scope.scenicSpotTicketPrice,$scope.sumPrice=$scope.price,console.log("全票总价"),console.log($scope.sumPrice),$scope.sumPrice2=$scope.price2,console.log("车票总价"),console.log($scope.sumPrice2),$scope.sumPrice3=$scope.price3,console.log("门票总价"),console.log($scope.sumPrice3)):(console.log("无车票时"),$scope.price=$scope.ticketInfo.productPrice,$scope.sumPrice=$scope.price,console.log("全票总价"),console.log($scope.sumPrice)),$scope.incr=function(){this.dataContainer.count<$scope.leftTickets?(this.dataContainer.count+=1,$scope.sumPrice=$scope.floatObj.multiply($scope.price,$scope.dataContainer.count,2),1==$scope.ticketInfo.haveTicket&&($scope.sumPrice2=$scope.floatObj.multiply($scope.price2,$scope.dataContainer.count,2),$scope.sumPrice3=$scope.floatObj.multiply($scope.price3,$scope.dataContainer.count,2))):layer.open({content:"当前班次余票为: "+$scope.leftTickets,time:5})},$scope.decr=function(){this.dataContainer.count>1&&(this.dataContainer.count-=1,$scope.sumPrice=$scope.floatObj.multiply($scope.price,$scope.dataContainer.count,2),1==$scope.ticketInfo.haveTicket&&($scope.sumPrice2=$scope.floatObj.multiply($scope.price2,$scope.dataContainer.count,2),$scope.sumPrice3=$scope.floatObj.multiply($scope.price3,$scope.dataContainer.count,2)))},$scope.oldTicketPriceShow=!0,$scope.newTicketPriceShow=!1,$scope.useCoupon=!1;var couponCount=1;$scope.checkCoupon=function(){if("1"==$scope.ticketInfo.productType)var requestData={userid:$rootScope.session.user.userInfo.userid,gobdid:$scope.ticketInfo.gobdid,count:$scope.dataContainer.count,backbdid:$scope.ticketInfo.backbdid};else var requestData={userid:$rootScope.session.user.userInfo.userid,gobdid:$scope.ticketInfo.gobdid,count:$scope.dataContainer.count};couponCount%2==1?($scope.oldTicketPriceShow=!1,$scope.newTicketPriceShow=!0,$scope.useCoupon=!0,$myHttpService.post("api/product/queryUserBuslineCoupon",requestData,function(data){console.log("优惠券状态"),console.log(data.isHaveCoupon),data.isHaveCoupon?($scope.couponBtnState=!0,$scope.couponTxTShow=!1,$scope.newTicketPrice=data.showPrice):($scope.couponBtnState=!1,$scope.couponTxTShow=!0,$scope.newTicketPrice=0)},errorFn)):($scope.couponBtnState=!1,$scope.oldTicketPriceShow=!0,$scope.newTicketPriceShow=!1,$scope.useCoupon=!1),couponCount++},$scope.payBtnCheck=function(){if(void 0!=$scope.dataContainer.phone)if(11==$scope.dataContainer.phone.length){var phone=$scope.dataContainer.phone.toString();if(!/^1(3|4|5|7|8)\d{9}$/.test(phone))return layer.msg("输入的手机号码有误"),$scope.checkPhoneState=!1,!1;$scope.checkPhoneState=!0}else $scope.checkPhoneState=!1;else $scope.checkPhoneState=!1;$scope.payBtnDisabled=$scope.checkPhoneState&&$scope.dataContainer.verificationCode?!1:!0},$scope.recharge=function(){var departDate=$filter("date")($scope.ticketInfo.departdate,"yyyy-MM-dd");if("1"==$scope.ticketInfo.productType)if(0==$scope.ticketInfo.haveTicket)var data2={userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,gobdid:$scope.ticketInfo.gobdid,couponuse:$scope.couponBtnState,departDate:departDate,count:$scope.dataContainer.count,authcode:$scope.dataContainer.verificationCode,backbdid:$scope.ticketInfo.backbdid};else var data2={userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,gobdid:$scope.ticketInfo.gobdid,couponuse:$scope.couponBtnState,departDate:departDate,count:$scope.dataContainer.count,authcode:$scope.dataContainer.verificationCode,backbdid:$scope.ticketInfo.backbdid,viewPriceId:$scope.scenicSpotTicketPriceID};else if(0==$scope.ticketInfo.haveTicket)var data2={userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,gobdid:$scope.ticketInfo.gobdid,couponuse:$scope.couponBtnState,departDate:departDate,count:$scope.dataContainer.count,authcode:$scope.dataContainer.verificationCode};else var data2={userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,gobdid:$scope.ticketInfo.gobdid,couponuse:$scope.couponBtnState,departDate:departDate,count:$scope.dataContainer.count,authcode:$scope.dataContainer.verificationCode,viewPriceId:$scope.scenicSpotTicketPriceID};console.log("ZW：传递到order_detail_refund的参数"),console.log(data2),$myHttpService.post("api/product/buyProductTicket",data2,function(data){function onBridgeReady(){WeixinJSBridge.invoke("getBrandWCPayRequest",wxData,function(res){"get_brand_wcpay_request:ok"==res.err_msg?$myHttpService.post("api/recharge/verifyWxorderStatus",{rechargeid:$scope.rechargeid},function(){alert("您已成功支付"),console.log("微信订单支付成功，传递参数打印"),console.log(data2),$state.go("order_detail_refund",{data:JSON.stringify(data2)},{reload:!0})},function(){layer.open({content:"支付失败，请联系客服处理。",btn:"确定"})}):layer.open("get_brand_wcpay_request:cancel"==res.err_msg?{content:"你取消了本次支付",btn:"确定"}:{content:"支付失败，请联系客服处理。",btn:"确定"})})}if(console.log(data),null!=data.counponUse)data.updateCoupon?(console.log(data2),$state.go("order_detail_refund",{data:JSON.stringify(data2)},{reload:!0})):layer.open({content:"支付失败",btn:"确定"});else{$scope.rechargeid=data.rechargeid;var wxData={appId:data.appId,timeStamp:data.timeStamp,nonceStr:data.nonceStr,"package":data.package,signType:data.signType,paySign:data.paySign};"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",onBridgeReady,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",onBridgeReady),document.attachEvent("onWeixinJSBridgeReady",onBridgeReady)):onBridgeReady()}})},1==$scope.ticketInfo.haveTicket&&($scope.modal=$ionicModal.fromTemplate('<ion-modal-view>	          <ion-header-bar class="bar bar-header bar-light">		          <h1 class="title"> </h1>          <button class="button button-balanced" ng-click="chooseScenicSpotTicket()">确定</button>		          </ion-header-bar>		        <ion-content class="padding">		    <p style="text-align:center;font-size: 18px;"><span>{{ticketInfo.viewName}}</span></p>				<ion-radio style="padding: 15px 10px;border: none;border-bottom-style: solid;border-bottom-width: 1px;border-bottom-color: #ddd;border-top-width: 1px;border-top-color: #ddd;border-top-style: solid;" ng-repeat="item in scenicSpotTicketArr"               ng-value="item.viewPriceType"               ng-model="scenicSpotTicket.type">      			{{ item.viewPriceType }} <span style="margin-left: 5px;" >{{ item.couponPrice }} 元</span>     		</ion-radio>			        </ion-content>		      </ion-modal-view>',{scope:$scope,animation:"slide-in-up"}),$scope.scenicSpotTicketArr=$scope.ticketInfo.viewPrices,$scope.scenicSpotTicket={type:$scope.ticketInfo.viewPrices[0].viewPriceType},$scope.chooseScenicSpotTicket=function(){for(var item in $scope.ticketInfo.viewPrices){var objTemp=$scope.ticketInfo.viewPrices[item];objTemp.viewPriceType==$scope.scenicSpotTicket.type&&($scope.scenicSpotTicketPrice=objTemp.couponPrice,$scope.scenicSpotTicketPriceID=objTemp.viewPriceId)}$scope.price=$scope.floatObj.add($scope.ticketInfo.productPrice,$scope.scenicSpotTicketPrice,2),$scope.sumPrice=$scope.floatObj.multiply($scope.price,$scope.dataContainer.count,2),console.log("全票总价"),console.log($scope.sumPrice),$scope.sumPrice2=$scope.floatObj.multiply($scope.price2,$scope.dataContainer.count,2),console.log("车票总价"),console.log($scope.sumPrice2),$scope.price3=$scope.scenicSpotTicketPrice,$scope.sumPrice3=$scope.floatObj.multiply($scope.price3,$scope.dataContainer.count,2),console.log("门票总价"),console.log($scope.sumPrice3),$scope.modal.hide(),console.log($scope.scenicSpotTicketPriceID)},$scope.$on("$destroy",function(){$scope.modal.remove()}))}).controller("order_detail_refund",function($rootScope,$scope,$filter,$state,$myHttpService,$ionicSlideBoxDelegate){if(null==JSON.parse($state.params.data)){if(null==sessionStorage.getItem("order_detail_refund_backbdid"))var requestData={userid:sessionStorage.getItem("order_detail_refund_userid"),departDate:sessionStorage.getItem("order_detail_refund_departDate"),gobdid:sessionStorage.getItem("order_detail_refund_gobdid"),count:sessionStorage.getItem("order_detail_refund_count")};else var requestData={userid:sessionStorage.getItem("order_detail_refund_userid"),departDate:sessionStorage.getItem("order_detail_refund_departDate"),gobdid:sessionStorage.getItem("order_detail_refund_gobdid"),backbdid:sessionStorage.getItem("order_detail_refund_backbdid"),count:sessionStorage.getItem("order_detail_refund_count")};$myHttpService.post("api/product/queryProductOrderByBdid",requestData,function(data){console.log(data),null==data.backViewOrders?($scope.ticketsInfo=data.viewOrders,$scope.ticketsInfoLength=data.viewOrders.length):($scope.ticketsInfo=data.viewOrders.concat(data.backViewOrders),$scope.ticketsInfoLength=$scope.ticketsInfo.length),$ionicSlideBoxDelegate.update()},errorFn)}else{var paramsData=JSON.parse($state.params.data);if(console.log("支付成功后，传递过来的参数"),console.log(paramsData),sessionStorage.setItem("order_detail_refund_userid",paramsData.userid),sessionStorage.setItem("order_detail_refund_departDate",paramsData.departDate),sessionStorage.setItem("order_detail_refund_gobdid",paramsData.gobdid),sessionStorage.setItem("order_detail_refund_count",paramsData.count),null==paramsData.backbdid){var requestData={userid:paramsData.userid,departDate:paramsData.departDate,gobdid:paramsData.gobdid,count:paramsData.count};null!=sessionStorage.getItem("order_detail_refund_backbdid")&&sessionStorage.removeItem("order_detail_refund_backbdid)")}else{var requestData={userid:paramsData.userid,departDate:paramsData.departDate,gobdid:paramsData.gobdid,backbdid:paramsData.backbdid,count:paramsData.count};sessionStorage.setItem("order_detail_refund_backbdid",paramsData.backbdid)}$myHttpService.post("api/product/queryProductOrderByBdid",requestData,function(data){console.log(data),null==data.backViewOrders?($scope.ticketsInfo=data.viewOrders,$scope.ticketsInfoLength=data.viewOrders.length):($scope.ticketsInfo=data.viewOrders.concat(data.backViewOrders),$scope.ticketsInfoLength=$scope.ticketsInfo.length),$ionicSlideBoxDelegate.update()},errorFn)}$scope.getBusPosition=function(i){var data={carid:$scope.ticketsInfo[i].carid,lineid:$scope.ticketsInfo[i].lineid};$state.go("ticket_detail.bus_position",{data:JSON.stringify(data)},{reload:!1})}}).controller("order_check_comment",function($rootScope,$scope,$timeout,$state,$filter,$myHttpService){if($scope.submitBtnIsDiasbled=!0,null==JSON.parse($state.params.data))$state.go("myplan",{},{location:"replace"});else{$scope.isCommented=JSON.parse($state.params.isCommented),$scope.isCommentedText=JSON.parse($state.params.isCommentedText),$scope.isCommentedScore=JSON.parse($state.params.isCommentedScore);var paramsData=JSON.parse($state.params.data),requestData={viewOrderid:paramsData.viewOrderid};$myHttpService.post("api/product/queryUserProductTicketDetails",requestData,function(data){console.log(data),$scope.ticketInfo=data.viewOrder},errorFn),$scope.dataContainer={text:""},$scope.max=5,$scope.ratingVal=5,$scope.readonly=!1,$scope.onHover=function(val){$scope.ratingVal=val},$scope.onLeave=function(){},$scope.submitBtnCheck=function(){$scope.submitBtnIsDiasbled=$scope.dataContainer.text?!1:!0},$scope.submitComment=function(){var data={viewOrderid:paramsData.viewOrderid,orderScore:$scope.ratingVal,orderhie:$scope.dataContainer.text};console.log(data),$myHttpService.post("api/product/insertViewOrderHierarchy",data,function(){layer.open({content:"评价提交成功",btn:"确定",shadeClose:!1,yes:function(index){$state.go("myplan",{},{location:"replace"}),layer.close(index)}})},errorFn)},$scope.getBusPosition=function(){var data={carid:$scope.ticketInfo.carid,lineid:$scope.ticketInfo.lineid};console.log(data),$state.go("ticket_detail.bus_position",{data:JSON.stringify(data)},{reload:!0})}}}).controller("order_refunding",function($rootScope,$scope,$state){if(null==JSON.parse($state.params.data))$state.go("myplan",{},{location:"replace"});else{var paramsData=JSON.parse($state.params.data);console.log(paramsData),$scope.ticketInfo=paramsData}}).controller("myplan",function($rootScope,$scope,$filter,$myHttpService,$state){if(null==sessionStorage.getItem("myplanCount"))var myplanCount=1;else var myplanCount=sessionStorage.getItem("myplanCount");1==myplanCount&&($rootScope.ticketsInfo=[],sessionStorage.setItem("myplanCount",2),$rootScope.hasmore2=!0,$scope.pageCount=1,$scope.hasmore=!0);var run=!1;$scope.ticketsInfoIsEmpty=!1;var compare=function(prop){return function(obj1,obj2){var val1=obj1[prop],val2=obj2[prop];return void 0==val1&&(val1=1e5),void 0==val2&&(val2=1e5),isNaN(Number(val1))||isNaN(Number(val2))||(val1=Number(val1)/1e4,val2=Number(val2)/1e4),val2-val1}};$rootScope.hasmore2&&($scope.loadMoreTicket=function(){console.log("loadMoreTicket执行了");var offset=10*($scope.pageCount-1),requestData={userid:$rootScope.session.user.userInfo.userid,offset:offset,pagesize:10};run||(run=!0,$myHttpService.postNoLoad("api/product/queryUserProductTicketList",requestData,function(data){data.userViewList.length<10?($scope.hasmore=!1,$rootScope.hasmore2=!1):$scope.pageCount++,run=!1,$rootScope.ticketsInfo=$rootScope.ticketsInfo.concat(data.userViewList),console.log($rootScope.ticketsInfo),$rootScope.ticketsInfo.sort(compare("departDate")),$scope.$broadcast("scroll.infiniteScrollComplete"),0==$rootScope.ticketsInfo.length&&($scope.ticketsInfoIsEmpty=!0)},function(){$scope.$broadcast("scroll.infiniteScrollComplete")}))}),$scope.doRefreshTicket=function(){var requestData={userid:$rootScope.session.user.userInfo.userid,offset:0,pagesize:10};$scope.pageCount=2,$rootScope.hasmore2=!0,$myHttpService.postNoLoad("api/product/queryUserProductTicketList",requestData,function(data){$rootScope.ticketsInfo=data.userViewList,$rootScope.ticketsTotal=data.totalnum,$scope.$broadcast("scroll.refreshComplete"),0==$rootScope.ticketsInfo.length?$scope.ticketsInfoIsEmpty=!0:layer.open({content:"刷新成功",skin:"msg",time:1}),$scope.$broadcast("scroll.refreshComplete")},function(){$scope.$broadcast("scroll.refreshComplete")})},$scope.unusedTicketToDetail=function(item){$state.go("ticket_detail.ticketdetail",{data:JSON.stringify(item)},{reload:!1})},$scope.usedTicketToComment=function(item){var isCommented=!1,isCommentedText="",isCommentedScore=1;null!=item.orderhie&&(isCommented=!0,isCommentedText=item.orderhie,isCommentedScore=item.orderScore),$state.go("order_check_comment",{data:JSON.stringify(item),isCommented:JSON.stringify(isCommented),isCommentedText:JSON.stringify(isCommentedText),isCommentedScore:JSON.stringify(isCommentedScore)},{reload:!0})},$scope.refundingToRefund=function(item){$state.go("order_refunding",{data:JSON.stringify(item)},{reload:!1})}}).controller("test",function($rootScope,$scope){$scope.thumb={},$scope.getGuid=function(){function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()},$scope.chooseImg=function($event){console.log($event),wx.chooseImage({count:2,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(res){for(var localIds=res.localIds,i=0;i<localIds.length;i++){var guid=$scope.getGuid();$scope.$apply(function(){$scope.thumb[guid]={guid:guid}})}},fail:function(res){alterShowMessage("操作提示",JSON.stringify(res),"1","确定","","","")}})},$scope.sumArr=[{type:"single",msg:"单程票，贵阳-武汉"},{type:"single",msg:"单程票，贵阳-杭州"},{type:"single",msg:"单程票，贵阳-北京"},{type:"double",msg:"往返票，贵阳-拉萨"},{type:"double",msg:"往返票，贵阳-新疆"},{type:"double",msg:"往返票，贵阳-墨脱"}],$scope.cccccccc=function(){layer.open({content:"您确定要刷新一下本页面吗？",btn:["刷新","不要"],shadeClose:!1,yes:function(index){location.reload(),layer.close(index)}})}}).controller("BusPositionController",function($scope,$myHttpService,$timeout,$state){if(null==JSON.parse($state.params.data)){var lineArr=[116.397428,39.90923],map=new AMap.Map("J_map_canvas",{resizeEnable:!0,center:[lineArr[0],lineArr[1]],zoom:17});marker=new AMap.Marker({map:map,position:[lineArr[0],lineArr[1]],icon:"http://webapi.amap.com/images/car.png",content:'<i class="icon ion-ios-location" style="color: #f71909;font-size:30px"></i>',offset:new AMap.Pixel(-26,-13),animation:"AMAP_ANIMATION_DROP"}),$timeout(function(){layer.open({content:"请求车辆位置出错，请重试",btn:"确定",shadeClose:!1,yes:function(index){$state.go("myplan",{},{location:"replace"}),layer.close(index)}})},1500)}else{var paramsData=JSON.parse($state.params.data);console.log("传到定位地图页面的参数"),console.log(paramsData),$scope.positionArr={},$myHttpService.post("api/product/queryCarLocation",{carid:paramsData.carid,lineid:paramsData.lineid},function(data){console.log(data),$scope.positionArr=data.car,$scope.busline=data.busline,$scope.stations=data.stations;var lineArr=[$scope.positionArr.currlon,$scope.positionArr.currlat],map=new AMap.Map("J_map_canvas",{resizeEnable:!0,center:[lineArr[0],lineArr[1]],zoom:11}),allLonLatArr=[],stationType1=[];for(var index in $scope.stations){var item=$scope.stations[index],tempArr=[item.stalongitude,item.stalatitude];if(allLonLatArr.push(tempArr),1==item.stationType){var tempArr2=[[item.stalongitude,item.stalatitude],item.stationname];stationType1.push(tempArr2)}}AMapUI.load(["ui/misc/PathSimplifier","ui/overlay/SimpleMarker"],function(PathSimplifier){if(!PathSimplifier.supportCanvas){alert("当前环境不支持 Canvas！");
var startPositionLonLat=[$scope.busline.departlon,$scope.busline.departlat],endPositionLonLat=[$scope.busline.arrivelon,$scope.busline.arrivelat];return void AMap.plugin("AMap.Driving",function(){var drving=new AMap.Driving({map:map});drving.search(startPositionLonLat,endPositionLonLat)})}var pathSimplifierIns=new PathSimplifier({zIndex:100,map:map,getPath:function(pathData){return pathData.path},getHoverTitle:function(pathData,pathIndex,pointIndex){return pointIndex>=0?pathData.name+"，点："+pointIndex+"/"+pathData.path.length:pathData.name+"，点数量"+pathData.path.length},renderOptions:{renderAllPointsIfNumberBelow:100,pathLineStyle:{strokeStyle:"red",lineWidth:6,dirArrowStyle:!0}}});window.pathSimplifierIns=pathSimplifierIns,pathSimplifierIns.setData([{name:"车辆运行路线",path:allLonLatArr}]);for(var index in stationType1){var item=stationType1[index];new AMap.Marker({map:map,position:item[0],content:'<i class="icon ion-flag" style="font-size:22px"></i>',label:{content:item[1],offset:new AMap.Pixel(11,31)}})}var navg1=pathSimplifierIns.createPathNavigator(0,{loop:!0,speed:2500});navg1.start()}),$timeout(function(){new AMap.Marker({map:map,position:[lineArr[0],lineArr[1]],content:'<i class="icon ion-ios-location" style="color: #f71909;font-size:30px"></i>',animation:"AMAP_ANIMATION_DROP"}),new AMap.Circle({map:map,center:[lineArr[0],lineArr[1]],redius:100,fillOpacity:.1,fillColor:"#09f",strokeColor:"#09f",strokeWeight:1});AMap.plugin("AMap.Geocoder",function(){var str="加载中>>>",geocoder=new AMap.Geocoder({});geocoder.getAddress([lineArr[0],lineArr[1]],function(status,result){if("complete"==status){str=result.regeocode.formattedAddress;var info=new AMap.InfoWindow({content:'<div class="title_bus_position">当前车辆位置</div><div class="content_bus_position">'+str+"<br/></div>",offset:new AMap.Pixel(0,-28),size:new AMap.Size(200,0)});info.open(map,[lineArr[0],lineArr[1]])}})})},1500)},errorFn)}}).controller("ticket_detail",function($rootScope,$scope,$filter,$interval,$myHttpService,$state){function ShowCountDown(endTime){var now=new Date,leftTime=endTime-now.getTime();if(leftTime>0){var leftsecond=parseInt(leftTime/1e3);$scope.day=Math.floor(leftsecond/86400),$scope.hour=Math.floor((leftsecond-24*$scope.day*60*60)/3600),$scope.minute=Math.floor((leftsecond-24*$scope.day*60*60-3600*$scope.hour)/60),$scope.second=Math.floor(leftsecond-24*$scope.day*60*60-3600*$scope.hour-60*$scope.minute)}else clearInterval(stopCountDown),$scope.timeText="",$scope.timeShow=!1}$scope.timeShow=!1,$scope.timeText="距离发车时间还剩";var stopCountDown=null;if(null==JSON.parse($state.params.data)){var viewOrderid=sessionStorage.getItem("ticket_detail_viewOrderid");$myHttpService.post("api/product/queryUserProductTicketDetails",{viewOrderid:viewOrderid},function(data){console.log(data),$scope.ticketInfo=data.viewOrder,$scope.refundData={rechargeid:data.viewOrder.rechargeid,userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,viewOrderid:data.viewOrder.viewOrderid,applyResult:!1},$scope.timeShow=!0;var temp=$filter("date")($scope.ticketInfo.departDate,"yyyy/MM/dd")+" "+$scope.ticketInfo.departTime,endTime=new Date(temp).getTime();stopTime=$interval(function(){ShowCountDown(endTime)},1e3)},errorFn)}else{var paramsData=JSON.parse($state.params.data),requestData={viewOrderid:paramsData.viewOrderid};sessionStorage.setItem("ticket_detail_viewOrderid",paramsData.viewOrderid),$myHttpService.post("api/product/queryUserProductTicketDetails",requestData,function(data){console.log(data),$scope.ticketInfo=data.viewOrder,$scope.refundData={rechargeid:data.viewOrder.rechargeid,userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,viewOrderid:data.viewOrder.viewOrderid,applyResult:!1},$scope.timeShow=!0;var temp=$filter("date")($scope.ticketInfo.departDate,"yyyy/MM/dd")+" "+$scope.ticketInfo.departTime,endTime=new Date(temp).getTime();stopTime=$interval(function(){ShowCountDown(endTime)},1e3)},errorFn)}$scope.$on("$destroy",function(){$interval.cancel(stopTime)}),$scope.refundBtnState=!1;$scope.refund=function(){console.log($scope.refundData),layer.open($scope.ticketInfo.counponUse?{content:"您确定要退款吗？",btn:["退款","不要"],shadeClose:!1,yes:function(index){$myHttpService.post("api/product/applyRefund",$scope.refundData,function(data){data.data.couponRefund?($scope.refundBtnState=!0,layer.open({content:"退款成功",btn:"确定",shadeClose:!1,yes:function(index){$state.go("myplan",{},{location:"replace"}),layer.close(index)}})):($scope.refundBtnState=!1,layer.open({content:"申请退款失败，请重试",btn:"确定",shadeClose:!1,yes:function(){}}))},errorFn),layer.close(index)}}:{content:"您确定要退款吗？",btn:["退款","不要"],shadeClose:!1,yes:function(index){$myHttpService.post("api/product/applyRefund",$scope.refundData,function(){$scope.refundBtnState=!0,layer.open({content:"申请退款成功，退款将按原路返回到支付账户，预计到账时间为0-3个工作日",btn:"确定",shadeClose:!1,yes:function(index){$state.go("myplan",{},{location:"replace"}),layer.close(index)}})},errorFn),layer.close(index)}})},$scope.getBusPosition=function(){var data={carid:$scope.ticketInfo.carid,lineid:$scope.ticketInfo.lineid};console.log(data),$state.go("ticket_detail.bus_position",{data:JSON.stringify(data)},{reload:!0})}}).controller("IUserController",function($rootScope,$scope,$location,$state,$myHttpService){$scope.tempUser={};var tempUser2={};$myHttpService.post("api/user/queryUserinfo",{userid:$rootScope.session.user.userInfo.userid},function(data){data.flag?($scope.user=data.user,$scope.userOther=$scope.user.userid.length>4?$scope.user.userid.substring(0,6)+"***"+$scope.user.userid.substring($scope.user.userid.length-4):$scope.user.userid.substring(0,6)+"***",tempUser2=angular.copy($scope.user)):$state.go("auth.login")}),$scope.editMode=!1,$scope.editCance=!1,$scope.editButtonText="设置",$scope.edit=function(){0==$scope.editMode?($scope.editCance=!0,$scope.editMode=!$scope.editMode,$scope.tempUser=angular.copy($scope.user),$scope.editButtonText="保存"):$scope.tempUser.username.length<2||$scope.tempUser.username.length>4||!/^[\u4e00-\u9fa5]{2,4}$/.test($scope.tempUser.username)||11!=$scope.tempUser.phone.length||!/^1(3|4|5|7|8)\d{9}$/.test($scope.tempUser.phone)?$scope.tempUser.username.length>4||$scope.tempUser.username.length<2||!/^[\u4e00-\u9fa5]{2,4}$/.test($scope.tempUser.username)?layer.open({content:"输入的姓名格式有误，长度为2-4个中文",btn:"确定"}):11!=$scope.tempUser.phone.length?layer.open({content:"输入的手机号有误，长度为11个数字",btn:"确定"}):/^1(3|4|5|7|8)\d{9}$/.test($scope.tempUser.phone)||layer.open({content:"输入的手机号格式有误",btn:"确定"}):($scope.editMode=!$scope.editMode,$scope.editButtonText="设置",$scope.editCance=!1,$myHttpService.post("api/user/modifyUserInfo",$scope.tempUser,function(){$scope.user=angular.copy($scope.tempUser)}))},$scope.cancel=function(){$scope.editMode=!1,$scope.editButtonText="设置",$scope.editCance=!1,$scope.user=angular.copy(tempUser2)}});