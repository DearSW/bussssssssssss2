var app=angular.module("app"),errorFn=function(){console.log("你好，数据请求失败")},storageData=function(name,data){sessionStorage.setItem(name,JSON.stringify(data))},getStorageData=function(name){return JSON.parse(sessionStorage.getItem(name))},formatParamObject=function(obj){for(var key in obj)""===obj[key]&&obj[key]!==!1&&delete obj[key];return obj},arrayMinus=function(arrA,arrB){for(var result=[],obj={},i=0;i<arrB.length;i++)obj[arrB[i]]=1;for(var j=0;j<arrA.length;j++)obj[arrA[j]]||(obj[arrA[j]]=1,result.push(arrA[j]));return result},floatObj=function(){function isInteger(obj){return Math.floor(obj)===obj}function toInteger(floatNum){var ret={times:1,num:0};if(isInteger(floatNum))return ret.num=floatNum,ret;var strfi=floatNum+"",dotPos=strfi.indexOf("."),len=strfi.substr(dotPos+1).length,times=Math.pow(10,len),intNum=parseInt(floatNum*times+.5,10);return ret.times=times,ret.num=intNum,ret}function operation(a,b,digits,op){var o1=toInteger(a),o2=toInteger(b),n1=o1.num,n2=o2.num,t1=o1.times,t2=o2.times,max=t1>t2?t1:t2,result=null;switch(op){case"add":return result=t1===t2?n1+n2:t1>t2?n1+n2*(t1/t2):n1*(t2/t1)+n2,result/max;case"subtract":return result=t1===t2?n1-n2:t1>t2?n1-n2*(t1/t2):n1*(t2/t1)-n2,result/max;case"multiply":return result=n1*n2/(t1*t2);case"divide":return result=n1/n2*(t2/t1)}}function add(a,b,digits){return operation(a,b,digits,"add")}function subtract(a,b,digits){return operation(a,b,digits,"subtract")}function multiply(a,b,digits){return operation(a,b,digits,"multiply")}function divide(a,b,digits){return operation(a,b,digits,"divide")}return{add:add,subtract:subtract,multiply:multiply,divide:divide}}();app.controller("City_select",function($rootScope,$scope,$state,$timeout,$interval,$myLocationService,$myHttpService,$ionicSlideBoxDelegate,$ionicActionSheet,$selectCity,$filter,ionicDatePicker,$ionicModal){function slideImage(){$rootScope.recommendProducts2&&$rootScope.recommendProducts2.length>0&&($rootScope.recommendProducts2Index=$rootScope.recommendProducts2Index===$rootScope.recommendProducts2.length-1?0:$rootScope.recommendProducts2Index+1,$rootScope.slideNumber=$ionicSlideBoxDelegate.$getByHandle("adBanner").currentIndex(),$rootScope.slideNumber+1!=$rootScope.recommendProducts2Index&&0!=$rootScope.recommendProducts2Index?($rootScope.recommendProducts2Index=$rootScope.slideNumber,$ionicSlideBoxDelegate.$getByHandle("adBanner").slide($rootScope.recommendProducts2Index)):$ionicSlideBoxDelegate.$getByHandle("adBanner").slide($rootScope.recommendProducts2Index))}var slideImageTimer=null;if(null==sessionStorage.getItem("recommendImgCount")){var recommendImgCount=1;$rootScope.recommendProducts2=[]}else var recommendImgCount=sessionStorage.getItem("recommendImgCount");if($scope.dataContainer={input:""},1==recommendImgCount&&(sessionStorage.setItem("recommendImgCount",2),$rootScope.showDefaultImg=!0,$myHttpService.postNoLoad("api/product/queryRecommendProductList",{},function(data){console.log("首页：图片推荐API返回的数据"),console.log(data),$rootScope.recommendProducts2=data.products,0==$rootScope.recommendProducts2.length?$timeout(function(){$rootScope.showDefaultImg=!0,$ionicSlideBoxDelegate.update()},500):($rootScope.showDefaultImg=!1,$ionicSlideBoxDelegate.update(),$timeout(function(){$ionicSlideBoxDelegate.next()},1e3))},errorFn)),slideImageTimer=$interval(function(){slideImage()},4e3),$scope.$on("$destroy",function(){$interval.cancel(slideImageTimer)}),$scope.recommendProductsDetail=function(item){var data={productid:item.productid};console.log("首页：点击图片进入产品页打印参数"),console.log(data),$state.go("tabs",{data:JSON.stringify(data)},{reload:!0})},1==recommendImgCount&&($rootScope.roadLineData=[],$myHttpService.postNoLoad("api/product/queryProductKeywords",{},function(data){console.log("首页：搜索关键字API返回的数据"),console.log(data),null!=data.products&&0!=data.products.length&&($rootScope.roadLineData=data.products,console.log("首页：路线数据数组"),console.log($rootScope.roadLineData))},errorFn),$rootScope.isSelectedRoadLine="",$rootScope.isSelectedRoadLineBoolean=!0,$rootScope.isSearchBtnDisabled=!0),$scope.modal=$ionicModal.fromTemplate('<ion-modal-view>	          <ion-header-bar class="bar bar-header modal-one" style="margin-top: 35%;box-shadow: none;" >		          <h1 class="title" style="font-weight: normal;color: #525151;"> 线路选择 </h1>          <button class="button button-balanced" ng-click="modal.hide()" style="background: rgba(240, 248, 255, 0.09);color: rgba(103, 100, 100, 0.67);">取消</button>		          </ion-header-bar>		        <ion-content class="padding" style="background: #ffffff;margin-top: 35%;" >			<button class="button button-outline button-dark" style="min-width: 0;min-height: 0;height: 42px;margin: 2px 4px 15px 8px;font-size: 14px;padding: 0px 7px;" ng-repeat="item in roadLineData track by $index" ng-click="selectedRoadLine(item.viewaddress)">{{item.viewaddress}}</button> 			        </ion-content>		      </ion-modal-view>',{scope:$scope,animation:"slide-in-up"}),$scope.openRoadLine=function(){$scope.modal.show()},$scope.selectedRoadLine=function(item){$rootScope.isSelectedRoadLineBoolean=!1,$rootScope.isSearchBtnDisabled=!1,console.log("首页：用户当前点击选择的路线"),console.log(item),$rootScope.isSelectedRoadLine=item,$scope.modal.hide()},null!=sessionStorage.getItem("jqztc_search_time"))var tempTime=sessionStorage.getItem("jqztc_search_time");else var tempTime=new Date;$scope.goDate={time:tempTime};var compareTime=(new Date).getTime()+5184e6;$scope.openDatePicker=function(){var ipObj1={callback:function(val){{var val2=new Date(val);$filter("date")(val2,"yyyy-MM-dd")}$scope.goDate.time=new Date(val)},titleLabel:"选择日期",closeLabel:"返回",from:new Date,to:new Date(compareTime),dateFormat:"yyyy-MM-dd",closeOnSelect:!0,inputDate:new Date,templateType:"modal"};ionicDatePicker.openDatePicker(ipObj1)},$scope.goTabs=function(){var data={input:$rootScope.isSelectedRoadLine,date:$filter("date")($scope.goDate.time,"yyyy-MM-dd")};console.log("首页：打印搜索按钮传递到产品页的参数"),console.log(data),sessionStorage.setItem("jqztc_search_time",data.date),$state.go("tabs",{data:JSON.stringify(data)},{reload:!0})}}).controller("Tabs",function($rootScope,$scope,$state,$timeout,$myHttpService){$scope.ticketsInfo1="",$scope.ticketsInfo2=[],$scope.commentsInfo=[],$scope.paramsProductId="",$scope.sourceComeType="",$rootScope.currentSelectedDate=null;var paramsData=JSON.parse($state.params.data);if(null!=paramsData)if(paramsData.hasOwnProperty("productid")){$scope.sourceComeType=!0,sessionStorage.setItem("jqztc_cpy_requestUrlType","0"),sessionStorage.setItem("jqztc_cpy_paramsProductId",paramsData.productid),$scope.paramsProductId=paramsData.productid,console.log("产品页：图片推荐类型流程，有参数，productid");var requestData={productid:paramsData.productid};$myHttpService.post("api/product/queryProduct",requestData,function(data){console.log("产品页：图片推荐产品列表API返回的数据"),console.log(data),$scope.ticketsInfo1=data.product,storageData("jqztc_cpy_ticketsInfo1",$scope.ticketsInfo1),null!=$scope.ticketsInfo1?null!=$scope.ticketsInfo1.plans?($scope.ticketsInfo1_havePlans=!0,$scope.ticketsInfo1_prodcutType=$scope.ticketsInfo1.productType.split("&"),$scope.ticketsInfo1_prodcutType2=$scope.ticketsInfo1.productType.replace("&","+"),$scope.ticketsInfo1_station=$scope.ticketsInfo1.plans[0].linename.split("-"),0==$scope.ticketsInfo1.plans[0].bdidType?($scope.ticketsInfo1_plansType=!0,$scope.ticketsInfo1_departAddr=$scope.ticketsInfo1.plans[0].departaddr,$scope.ticketsInfo1_driveTime=$scope.ticketsInfo1.plans[0].drivetime):($scope.ticketsInfo1_plansType=!1,$scope.ticketsInfo1_departAddr=$scope.ticketsInfo1.plans[0].departaddr,$scope.ticketsInfo1_arriveAddr=$scope.ticketsInfo1.plans[1].departaddr,$scope.ticketsInfo1_driveTime=$scope.ticketsInfo1.plans[0].drivetime)):($scope.ticketsInfo1_havePlans=!1,null!=$scope.ticketsInfo1.viewInfo&&($scope.ticketsInfo1_viewName=$scope.ticketsInfo1.viewInfo.viewName,$scope.ticketsInfo1_viewAddr=$scope.ticketsInfo1.viewInfo.viewaddr)):layer.open({content:"客官，您当前选择的推荐主题路线已售完，请返回进行主题线路搜索 (╯-╰)",btn:"确定",shadeClose:!1,yes:function(){layer.closeAll(),$timeout(function(){return window.history.back(),!1},250)}})},errorFn)}else{$scope.sourceComeType=!1,sessionStorage.setItem("jqztc_cpy_requestUrlType","1"),sessionStorage.setItem("tabsParamsDataInput",paramsData.input),sessionStorage.setItem("tabsParamsDataDate",paramsData.date),$rootScope.currentSelectedDate=paramsData.date,$rootScope.currentSelectedRoadLine=paramsData.input;var requestData={keyword:paramsData.input,departDate:paramsData.date};$myHttpService.post("api/product/queryProductList",requestData,function(data){console.log("产品页：手动搜索类型的产品列表API返回的数据"),console.log(data),$scope.ticketsInfo2=data.products,storageData("jqztc_cpy_ticketsInfo2",$scope.ticketsInfo2),0!=$scope.ticketsInfo2.length?$scope.paramsProductId=$scope.ticketsInfo2[0].productid:layer.open({content:"客官，没有找到相关产品信息，请重新搜索 (╯-╰)",btn:"确定",yes:function(){$timeout(function(){return window.history.back(),!1},250),layer.closeAll()}})},errorFn)}else"0"==sessionStorage.getItem("jqztc_cpy_requestUrlType")?($scope.sourceComeType=!0,$scope.paramsProductId=sessionStorage.getItem("jqztc_cpy_paramsProductId"),$scope.ticketsInfo1=getStorageData("jqztc_cpy_ticketsInfo1"),null!=$scope.ticketsInfo1?null!=$scope.ticketsInfo1.plans?($scope.ticketsInfo1_havePlans=!0,$scope.ticketsInfo1_prodcutType=$scope.ticketsInfo1.productType.split("&"),$scope.ticketsInfo1_prodcutType2=$scope.ticketsInfo1.productType.replace("&","+"),$scope.ticketsInfo1_station=$scope.ticketsInfo1.plans[0].linename.split("-"),0==$scope.ticketsInfo1.plans[0].bdidType?($scope.ticketsInfo1_plansType=!0,$scope.ticketsInfo1_departAddr=$scope.ticketsInfo1.plans[0].departaddr,$scope.ticketsInfo1_driveTime=$scope.ticketsInfo1.plans[0].drivetime):($scope.ticketsInfo1_plansType=!1,$scope.ticketsInfo1_departAddr=$scope.ticketsInfo1.plans[0].departaddr,$scope.ticketsInfo1_arriveAddr=$scope.ticketsInfo1.plans[1].departaddr,$scope.ticketsInfo1_driveTime=$scope.ticketsInfo1.plans[0].drivetime)):($scope.ticketsInfo1_havePlans=!1,null!=$scope.ticketsInfo1.viewInfo&&($scope.ticketsInfo1_viewName=$scope.ticketsInfo1.viewInfo.viewName,$scope.ticketsInfo1_viewAddr=$scope.ticketsInfo1.viewInfo.viewaddr)):layer.open({content:"客官，您当前选择的推荐主题路线已售完，请返回进行主题线路搜索 (╯-╰)",btn:"确定",shadeClose:!1,yes:function(){layer.closeAll(),$timeout(function(){return window.history.back(),!1},250)}})):"1"==sessionStorage.getItem("jqztc_cpy_requestUrlType")?($scope.sourceComeType=!1,$rootScope.currentSelectedDate=sessionStorage.getItem("tabsParamsDataDate"),$rootScope.currentSelectedRoadLine=sessionStorage.getItem("tabsParamsDataInput"),$scope.ticketsInfo2=getStorageData("jqztc_cpy_ticketsInfo2"),0!=$scope.ticketsInfo2.length?$scope.paramsProductId=$scope.ticketsInfo2[0].productid:layer.open({content:"客官，没有找到相关产品信息，请重新搜索 (╯-╰)",btn:"确定"})):$state.go("search");$scope.purchase=function(item){console.log("产品页：点击购买按钮传递的参数"),console.log(item),$state.go("order_confirm_pay",{data:JSON.stringify(item)})};var check_click_count=0,check_click_count2=0;$scope.tab_road=function(){1>check_click_count&&console.log("产品tab"),check_click_count++},$scope.tab_comment=function(){1>check_click_count2&&console.log("点评tab"),check_click_count2++},$scope.isNoComment=!1,$scope.pageCount=1,$scope.doRefreshComment=function(){console.log("产品页：doRefreshComment已执行"),$scope.pageCount=1,$myHttpService.postNoLoad("api/product/queryProductHieList",{offset:"0",pagesize:"10"},function(data){console.log("产品页：产品评价API返回的数据(下拉刷新)"),console.log(data),$scope.commentsInfo=data.buslineHierarchys,$scope.$broadcast("scroll.refreshComplete"),0==$scope.commentsInfo.length?$scope.isNoComment=!0:($scope.isNoComment=!1,layer.open({content:"刷新成功",skin:"msg",time:1}))})},$scope.hasmore=!0;var run=!1;$scope.loadMoreComment=function(){console.log("产品页：loadMoreComment已执行");var offset=10*($scope.pageCount-1),requestData={offset:offset,pagesize:"10"};run||(run=!0,$myHttpService.post("api/product/queryProductHieList",requestData,function(data){console.log("产品页：产品评价API返回的数据(上拉加载)"),console.log(data),data.buslineHierarchys.length<10&&($scope.hasmore=!1),$scope.pageCount++,console.log("计数： "+$scope.pageCount),run=!1,console.log("评论加载"),$scope.commentsInfo=$scope.commentsInfo.concat(data.buslineHierarchys),console.log($scope.commentsInfo),$scope.$broadcast("scroll.infiniteScrollComplete"),0==$scope.commentsInfo.length&&($scope.isNoComment=!0)}))},$scope.max=5,$scope.readonly=!0,$scope.onHover=function(){},$scope.onLeave=function(){}}).controller("order_confirm_pay",function($rootScope,$filter,$scope,$state,$myHttpService,$interval,$ionicModal,ionicDatePicker){if(null==JSON.parse($state.params.data))return window.history.go(-2),!1;$scope.floatObj=floatObj,$scope.dataContainer={phone:"",verificationCode:"",coupon:!1,count:1},$scope.sumPrice=0,$scope.ticketSumPrice=0,$scope.ticketSumPrice_forwardTicket=0,$scope.ticketSumPrice_backwardTicket=0,$scope.ticketViewSumPrice=0,$scope.coupon=0,$rootScope.customerPhone="18302505303",$scope.againObtainCheckCode=!1,$scope.currentSelectedDateOrTime=sessionStorage.getItem("tabsParamsDataDate"),null==$scope.currentSelectedDateOrTime&&($scope.currentSelectedDateOrTime=$filter("date")(new Date,"yyyy-MM-dd")),$scope.currentSelectedDateOrTime2="周"+"日一二三四五六".charAt(new Date($scope.currentSelectedDateOrTime).getDay());var paramsData=JSON.parse($state.params.data);if(console.log("订单页：传递到订单页的参数"),console.log(paramsData),$scope.ticketInfo=paramsData,$scope.paramsProductid=$scope.ticketInfo.productid,$scope.checkPhoneState=!1,$scope.verificationCodeBtnDisabled=!0,$scope.verificationCodeInputDisabled=!0,$scope.payBtnDisabled=!0,$scope.countdownTxtShow=!1,$scope.couponBtnState=!1,$scope.couponTxTShow=!1,null!=$scope.ticketInfo.plans&&($scope.ticketInfo_Ticket_tempRequestParamArr=[],null!=$scope.ticketInfo.plans[0]&&($scope.ticketInfo_forwardTicket_haveChoosed=!1,$scope.ticketInfo_forwardTicket_chooseTime_Modal=$ionicModal.fromTemplate('<ion-modal-view>	          <ion-header-bar class="bar bar-header modal-two" >				   <button class="button  button-balanced" ng-click="ticketInfo_forwardTicket_chooseTime_OKFn()" style="background: rgba(240, 248, 255, 0.09);color: #676464;">取消</button>          <h1 class="title" style="color: black;font-size: 17px;font-weight: 400;">请选择行程时间</h1>          <button class="button button-balanced" ng-click="ticketInfo_forwardTicket_chooseTime_OKFn()" style="background: rgba(240, 248, 255, 0.09);color: #676464;">确定</button>		        </ion-header-bar>		        <ion-content class="padding" style="background: #ffffff;margin-top: 300px;" >			<ion-radio style="padding: 15px 10px;border: none;font-size: 17px;" ng-repeat="item in ticketInfo_forwardTicket_arr"               ng-value="item.bdid"               ng-model="ticketInfo_forwardTicket_timeType.type">      			{{ item.departTime }} <span style="margin-left: 5px;color: #a2a2a2;font-size: 14px;" >剩<span style="color: #DF6A0D;">{{ item.leftTickets }}</span>座/{{ item. totalTickets}}座</span>     		</ion-radio>			        </ion-content>		      </ion-modal-view>',{scope:$scope,animation:"slide-in-up"}),$scope.ticketInfo_forwardTicket_count=1,$scope.ticketInfo_forwardTicket_price=0,$scope.ticketInfo_forwardTicket_bpid=$scope.ticketInfo.plans[0].bpid,$scope.ticketInfo_forwardTicket_selectGoTime_Fn=function(){$scope.ticketInfo_forwardTicket_haveChoosed=!1;var requestData={departDate:$filter("date")($scope.currentSelectedDateOrTime,"yyyy-MM-dd"),bpid:$scope.ticketInfo_forwardTicket_bpid};console.log(requestData),$myHttpService.post("api/product/queryBuslineScheduleDetailsByBpid",requestData,function(data){console.log("订单页：排班出发时间查询API返回的数据"),console.log(data),$scope.ticketInfo_forwardTicket_arr=data.details,0!=$scope.ticketInfo_forwardTicket_arr.length?($scope.ticketInfo_forwardTicket_timeType={type:$scope.ticketInfo_forwardTicket_arr[0].bdid},$scope.ticketInfo_forwardTicket_chooseTime_Modal.show()):layer.open({content:"客官，当前日期没有相关的车辆班次信息，请您重新选择日期 (╯-╰)",btn:"确定"})},errorFn)},$scope.ticketInfo_forwardTicket_chooseTime_OKFn=function(){for(var item in $scope.ticketInfo_forwardTicket_arr){var objTemp=$scope.ticketInfo_forwardTicket_arr[item];objTemp.bdid==$scope.ticketInfo_forwardTicket_timeType.type&&($scope.ticketInfo_forwardTicket_price=objTemp.price,$scope.ticketInfo_forwardTicket_time=objTemp.departTime,$scope.ticketInfo_forwardTicket_leftTickets=objTemp.leftTickets,$scope.ticketInfo_forwardTicket_totalTickets=objTemp.totalTickets,$scope.ticketInfo_forwardTicket_bdid=objTemp.bdid)}$scope.ticketInfo_forwardTicket_chooseTime_Modal.hide(),$scope.ticketInfo_forwardTicket_haveChoosed=!0,$scope.ticketSumPrice_forwardTicket=0,$scope.ticketSumPrice_forwardTicket=$scope.floatObj.multiply($scope.ticketInfo_forwardTicket_price,$scope.ticketInfo_forwardTicket_count,2),console.log("订单页：去程车票总价"),console.log($scope.ticketSumPrice_forwardTicket),$scope.ticketInfo_Ticket_tempRequestParamArr[0]=[$scope.ticketInfo_forwardTicket_bdid,$scope.ticketInfo_forwardTicket_count],console.log("订单页：车票参数数组"),console.log($scope.ticketInfo_Ticket_tempRequestParamArr)},$scope.ticketInfo_forwardTicket_incr=function(){if($scope.ticketInfo_forwardTicket_count<=$scope.ticketInfo_forwardTicket_leftTickets){$scope.ticketInfo_forwardTicket_count+=1;var tempPrice=$scope.floatObj.multiply($scope.ticketInfo_forwardTicket_price,1,2);$scope.ticketSumPrice_forwardTicket=$scope.floatObj.add($scope.ticketSumPrice_forwardTicket,tempPrice,2),console.log("订单页：去程车票总价"),console.log($scope.ticketSumPrice_forwardTicket),$scope.ticketInfo_Ticket_tempRequestParamArr[0][1]=$scope.ticketInfo_forwardTicket_count,console.log("订单页：车票参数数组"),console.log($scope.ticketInfo_Ticket_tempRequestParamArr)}else layer.open({content:"当前班次余票为: "+$scope.ticketInfo_forwardTicket_count,btn:"确定"})},$scope.ticketInfo_forwardTicket_decr=function(){if($scope.ticketInfo_forwardTicket_count>=1){$scope.ticketInfo_forwardTicket_count-=1;var tempPrice=$scope.floatObj.multiply($scope.ticketInfo_forwardTicket_price,1,2);$scope.ticketSumPrice_forwardTicket=$scope.floatObj.subtract($scope.ticketSumPrice_forwardTicket,tempPrice,2),console.log("订单页：去程车票总价"),console.log($scope.ticketSumPrice_forwardTicket),$scope.ticketInfo_Ticket_tempRequestParamArr[0][1]=$scope.ticketInfo_forwardTicket_count,console.log("订单页：车票参数数组"),console.log($scope.ticketInfo_Ticket_tempRequestParamArr)}},$scope.$on("$destroy",function(){$scope.ticketInfo_forwardTicket_chooseTime_Modal.remove()})),null!=$scope.ticketInfo.plans[1]&&($scope.ticketInfo_backwardTicket_haveChoosed=!1,$scope.ticketInfo_backwardTicket_chooseTime_Modal=$ionicModal.fromTemplate('<ion-modal-view>	          <ion-header-bar class="bar bar-header modal-two" >				   <button class="button  button-balanced" ng-click="ticketInfo_backwardTicket_chooseTime_OKFn()" style="background: rgba(240, 248, 255, 0.09);color: #676464;">取消</button>          <h1 class="title" style="color: black;font-size: 17px;font-weight: 400;">请选择行程时间</h1>          <button class="button button-balanced" ng-click="ticketInfo_backwardTicket_chooseTime_OKFn()" style="background: rgba(240, 248, 255, 0.09);color: #676464;">确定</button>		        </ion-header-bar>		        <ion-content class="padding" style="background: #ffffff;margin-top: 300px;" >			<ion-radio style="padding: 15px 10px;border: none;font-size: 17px;" ng-repeat="item in ticketInfo_backwardTicket_arr"               ng-value="item.bdid"               ng-model="ticketInfo_backwardTicket_timeType.type">      			{{ item.departTime }} <span style="margin-left: 5px;color: #a2a2a2;font-size: 14px;">剩<span style="color: #DF6A0D;">{{ item.leftTickets }}</span>座/{{ item. totalTickets}}座</span>     		</ion-radio>			        </ion-content>		      </ion-modal-view>',{scope:$scope,animation:"slide-in-up"}),$scope.ticketInfo_backwardTicket_count=1,$scope.ticketInfo_backwardTicket_price=0,$scope.ticketInfo_backwardTicket_bpid=$scope.ticketInfo.plans[1].bpid,$scope.ticketInfo_backwardTicket_selectGoTime_Fn=function(){$scope.ticketInfo_backwardTicket_haveChoosed=!1;var requestData={departDate:$filter("date")($scope.currentSelectedDateOrTime,"yyyy-MM-dd"),bpid:$scope.ticketInfo_backwardTicket_bpid};console.log(requestData),$myHttpService.post("api/product/queryBuslineScheduleDetailsByBpid",requestData,function(data){console.log("订单页：排班出发时间查询API返回的数据"),console.log(data),$scope.ticketInfo_backwardTicket_arr=data.details,0!=$scope.ticketInfo_backwardTicket_arr.length?($scope.ticketInfo_backwardTicket_timeType={type:$scope.ticketInfo_backwardTicket_arr[0].bdid},$scope.ticketInfo_backwardTicket_chooseTime_Modal.show()):layer.open({content:"客官，当前日期没有相关的车辆班次信息，请您重新选择日期 (╯-╰)",btn:"确定"})},errorFn)},$scope.ticketInfo_backwardTicket_chooseTime_OKFn=function(){for(var item in $scope.ticketInfo_backwardTicket_arr){var objTemp=$scope.ticketInfo_backwardTicket_arr[item];objTemp.bdid==$scope.ticketInfo_backwardTicket_timeType.type&&($scope.ticketInfo_backwardTicket_price=objTemp.price,$scope.ticketInfo_backwardTicket_time=objTemp.departTime,$scope.ticketInfo_backwardTicket_leftTickets=objTemp.leftTickets,$scope.ticketInfo_backwardTicket_totalTickets=objTemp.totalTickets,$scope.ticketInfo_backwardTicket_bdid=objTemp.bdid)}$scope.ticketInfo_backwardTicket_chooseTime_Modal.hide(),$scope.ticketInfo_backwardTicket_haveChoosed=!0,$scope.ticketSumPrice_backwardTicket=0,$scope.ticketSumPrice_backwardTicket=$scope.floatObj.multiply($scope.ticketInfo_backwardTicket_price,$scope.ticketInfo_backwardTicket_count,2),console.log("订单页：返程车票总价"),console.log($scope.ticketSumPrice_backwardTicket),$scope.ticketInfo_Ticket_tempRequestParamArr[1]=[$scope.ticketInfo_backwardTicket_bdid,$scope.ticketInfo_backwardTicket_count],console.log("订单页：车票参数数组"),console.log($scope.ticketInfo_Ticket_tempRequestParamArr)},$scope.ticketInfo_backwardTicket_incr=function(){if($scope.ticketInfo_backwardTicket_count<=$scope.ticketInfo_backwardTicket_leftTickets){$scope.ticketInfo_backwardTicket_count+=1;var tempPrice=$scope.floatObj.multiply($scope.ticketInfo_backwardTicket_price,1,2);$scope.ticketSumPrice_backwardTicket=$scope.floatObj.add($scope.ticketSumPrice_backwardTicket,tempPrice,2),console.log("订单页：返程车票总价"),console.log($scope.ticketSumPrice_backwardTicket),$scope.ticketInfo_Ticket_tempRequestParamArr[1][1]=$scope.ticketInfo_backwardTicket_count,console.log("订单页：车票参数数组"),console.log($scope.ticketInfo_Ticket_tempRequestParamArr)}else layer.open({content:"当前班次余票为: "+$scope.ticketInfo_backwardTicket_count,btn:"确定"})},$scope.ticketInfo_backwardTicket_decr=function(){if($scope.ticketInfo_backwardTicket_count>=1){$scope.ticketInfo_backwardTicket_count-=1;var tempPrice=$scope.floatObj.multiply($scope.ticketInfo_backwardTicket_price,1,2);$scope.ticketSumPrice_backwardTicket=$scope.floatObj.subtract($scope.ticketSumPrice_backwardTicket,tempPrice,2),console.log("订单页：返程车票总价"),console.log($scope.ticketSumPrice_backwardTicket),$scope.ticketInfo_Ticket_tempRequestParamArr[1][1]=$scope.ticketInfo_backwardTicket_count,console.log("订单页：车票参数数组"),console.log($scope.ticketInfo_Ticket_tempRequestParamArr)}},$scope.$on("$destroy",function(){$scope.ticketInfo_backwardTicket_chooseTime_Modal.remove()}))),null!=$scope.ticketInfo.viewInfo){var len=$scope.ticketInfo.viewInfo.viewPrices.length;$scope.ticketInfo_viewInfo_tempRequestParamArr=[],$scope.ticketInfo_viewInfo_priceStr="";for(var index in $scope.ticketInfo.viewInfo.viewPrices){var item=$scope.ticketInfo.viewInfo.viewPrices[index];$scope.ticketInfo_viewInfo_priceStr+=item.viewPriceType+item.couponPrice+"元 ",$scope["ticketInfo_viewInfo_count"+index]=0}$scope.ticket_viewInfo_incr=function(index){for(var i=0;len>i;i++)if(index==i&&$scope["ticketInfo_viewInfo_count"+index]<99){$scope["ticketInfo_viewInfo_count"+index]+=1,console.log("订单页：相应门票的数量"+$scope["ticketInfo_viewInfo_count"+index]),$scope.ticketInfo_viewInfo_tempRequestParamArr[index]=[$scope.ticketInfo.viewInfo.viewPrices[index].viewPriceId,$scope["ticketInfo_viewInfo_count"+index]];var tempPrice=$scope.floatObj.multiply($scope.ticketInfo.viewInfo.viewPrices[index].couponPrice,1,2);$scope.ticketViewSumPrice=$scope.floatObj.add($scope.ticketViewSumPrice,tempPrice,2),console.log("订单页：门票请求参数数组"),console.log($scope.ticketInfo_viewInfo_tempRequestParamArr),console.log("订单页：对应的门票价格"),console.log(tempPrice),console.log("订单页：门票总价"),console.log($scope.ticketViewSumPrice)}},$scope.ticket_viewInfo_decr=function(index){for(var i=0;len>i;i++)if(index==i&&$scope["ticketInfo_viewInfo_count"+index]>=1){$scope["ticketInfo_viewInfo_count"+index]-=1,console.log("订单页：相应门票的数量"+$scope["ticketInfo_viewInfo_count"+index]),$scope.ticketInfo_viewInfo_tempRequestParamArr[index]=[$scope.ticketInfo.viewInfo.viewPrices[index].viewPriceId,$scope["ticketInfo_viewInfo_count"+index]];var tempPrice=$scope.floatObj.multiply($scope.ticketInfo.viewInfo.viewPrices[index].couponPrice,1,2);$scope.ticketViewSumPrice=$scope.floatObj.subtract($scope.ticketViewSumPrice,tempPrice,2),console.log("订单页：门票请求参数数组"),console.log($scope.ticketInfo_viewInfo_tempRequestParamArr),console.log("订单页：对应的门票价格"),console.log(tempPrice),console.log("订单页：门票总价"),console.log($scope.ticketViewSumPrice)}}}if($scope.nextDay=function(){var nextDayTime=new Date($scope.currentSelectedDateOrTime).getTime()+864e5,temp1=new Date,temp2=$filter("date")(temp1,"yyyy-MM-dd"),endTime=new Date(temp2).getTime()+5184e6;if(endTime>=nextDayTime){var temp=new Date(nextDayTime);if($scope.currentSelectedDateOrTime=$filter("date")(temp,"yyyy-MM-dd"),$scope.currentSelectedDateOrTime2="周"+"日一二三四五六".charAt(new Date($scope.currentSelectedDateOrTime).getDay()),$scope.stopFight(),$scope.resetFight(),$scope.countdownTxtShow=!1,$scope.verificationCodeBtnDisabled=0==$scope.verificationCodeBtnDisabled?!1:!0,$scope.dataContainer.verificationCode="",$scope.againObtainCheckCode=!0,$scope.payBtnDisabled=!0,null!=$scope.ticketInfo.viewInfo){{$scope.ticketInfo.viewInfo.viewPrices.length}$scope.ticketInfo_viewInfo_tempRequestParamArr=[];for(var index in $scope.ticketInfo.viewInfo.viewPrices)$scope["ticketInfo_viewInfo_count"+index]=0;$scope.ticketViewSumPrice=0}1==$scope.useCoupon&&($scope.couponType.type="",$scope.couponPrice=0,$scope.useCoupon=!1,$scope.noCouponTxt=!1,$scope.noCouponTxt2=!1),null!=$scope.ticketInfo_forwardTicket_arr&&($scope.ticketInfo_forwardTicket_count=1,$scope.ticketInfo_forwardTicket_arr=[],$scope.ticketInfo_forwardTicket_haveChoosed=!1,$scope.ticketSumPrice_forwardTicket=0),null!=$scope.ticketInfo_backwardTicket_arr&&($scope.ticketInfo_backwardTicket_count=1,$scope.ticketInfo_backwardTicket_arr=[],$scope.ticketInfo_backwardTicket_haveChoosed=!1,$scope.ticketSumPrice_backwardTicket=0)}else layer.open({content:"不在预售范围内，预售期仅为60天，请重新选择！",btn:"确定"})},$scope.prevDay=function(){var prevDayTime=new Date($scope.currentSelectedDateOrTime).getTime()-864e5,temp3=new Date,temp4=$filter("date")(temp3,"yyyy-MM-dd"),startTime=new Date(temp4).getTime();if(prevDayTime>=startTime){var temp=new Date(prevDayTime);if($scope.currentSelectedDateOrTime=$filter("date")(temp,"yyyy-MM-dd"),$scope.currentSelectedDateOrTime2="周"+"日一二三四五六".charAt(new Date($scope.currentSelectedDateOrTime).getDay()),$scope.stopFight(),$scope.resetFight(),$scope.countdownTxtShow=!1,$scope.verificationCodeBtnDisabled=0==$scope.verificationCodeBtnDisabled?!1:!0,$scope.dataContainer.verificationCode="",$scope.againObtainCheckCode=!0,$scope.payBtnDisabled=!0,null!=$scope.ticketInfo.viewInfo){{$scope.ticketInfo.viewInfo.viewPrices.length}$scope.ticketInfo_viewInfo_tempRequestParamArr=[];for(var index in $scope.ticketInfo.viewInfo.viewPrices)$scope["ticketInfo_viewInfo_count"+index]=0;$scope.ticketViewSumPrice=0}1==$scope.useCoupon&&($scope.couponType.type="",$scope.couponPrice=0,$scope.useCoupon=!1,$scope.noCouponTxt=!1,$scope.noCouponTxt2=!1),null!=$scope.ticketInfo_forwardTicket_arr&&($scope.ticketInfo_forwardTicket_count=1,$scope.ticketInfo_forwardTicket_arr=[],$scope.ticketInfo_forwardTicket_haveChoosed=!1,$scope.ticketSumPrice_forwardTicket=0),null!=$scope.ticketInfo_backwardTicket_arr&&($scope.ticketInfo_backwardTicket_count=1,$scope.ticketInfo_backwardTicket_arr=[],$scope.ticketInfo_backwardTicket_haveChoosed=!1,$scope.ticketSumPrice_backwardTicket=0)}else{var temp=new Date,temp2=$filter("date")(temp,"yyyy-MM-dd");layer.open({content:"选择日期仅当从"+temp2+"往后",btn:"确定"})}},$scope.canPurchaseInfo=!1,null!=$scope.ticketInfo.counts&&0!=$scope.ticketInfo.counts.length){$scope.canPurchaseInfo=!0,$scope.canPurchaseInfoTxt="",$scope.disabledWeeks=[],$scope.disabledWeeksTemp=[0,1,2,3,4,5,6],$scope.disabledWeeksTemp1=$scope.ticketInfo.counts.map(function(item){return item-1}).sort(),$scope.disabledWeeks=arrayMinus($scope.disabledWeeksTemp,$scope.disabledWeeksTemp1),$scope.disabledWeeksTemp1.toString()==$scope.disabledWeeksTemp.toString()&&($scope.canPurchaseInfo=!1);for(var i=0;i<$scope.disabledWeeksTemp1.length;i++)switch($scope.disabledWeeksTemp1[i]){case 1:$scope.canPurchaseInfoTxt+="周一";break;case 2:$scope.canPurchaseInfoTxt+="周二";break;case 3:$scope.canPurchaseInfoTxt+="周三";break;case 4:$scope.canPurchaseInfoTxt+="周四";break;case 5:$scope.canPurchaseInfoTxt+="周无";break;case 6:$scope.canPurchaseInfoTxt+="周六";break;case 0:$scope.canPurchaseInfoTxt+="周日"}}else $scope.disabledWeeks=[],$scope.canPurchaseInfo=!1;console.log("订单页：被禁用的星期数组"),console.log($scope.disabledWeeks);var compareTimeTemp1=new Date,compareTimeTemp2=$filter("date")(compareTimeTemp1,"yyyy-MM-dd"),compareTime=new Date(compareTimeTemp2).getTime()+5184e6;$scope.selectDay=function(){var ipObj1={callback:function(val){var val2=new Date(val);if($scope.currentSelectedDateOrTime=$filter("date")(val2,"yyyy-MM-dd"),$scope.currentSelectedDateOrTime2="周"+"日一二三四五六".charAt(new Date($scope.currentSelectedDateOrTime).getDay()),$scope.stopFight(),$scope.resetFight(),$scope.countdownTxtShow=!1,$scope.verificationCodeBtnDisabled=0==$scope.verificationCodeBtnDisabled?!1:!0,$scope.dataContainer.verificationCode="",$scope.againObtainCheckCode=!0,$scope.payBtnDisabled=!0,null!=$scope.ticketInfo.viewInfo){{$scope.ticketInfo.viewInfo.viewPrices.length}$scope.ticketInfo_viewInfo_tempRequestParamArr=[];for(var index in $scope.ticketInfo.viewInfo.viewPrices)$scope["ticketInfo_viewInfo_count"+index]=0;$scope.ticketViewSumPrice=0}1==$scope.useCoupon&&($scope.couponType.type="",$scope.couponPrice=0,$scope.useCoupon=!1,$scope.noCouponTxt=!1,$scope.noCouponTxt2=!1),null!=$scope.ticketInfo_forwardTicket_arr&&($scope.ticketInfo_forwardTicket_count=1,$scope.ticketInfo_forwardTicket_arr=[],$scope.ticketInfo_forwardTicket_haveChoosed=!1,$scope.ticketSumPrice_forwardTicket=0),null!=$scope.ticketInfo_backwardTicket_arr&&($scope.ticketInfo_backwardTicket_count=1,$scope.ticketInfo_backwardTicket_arr=[],$scope.ticketInfo_backwardTicket_haveChoosed=!1,$scope.ticketSumPrice_backwardTicket=0)},titleLabel:"选择日期",closeLabel:"返回",from:new Date,to:new Date(compareTime),dateFormat:"yyyy-MM-dd",closeOnSelect:!0,inputDate:new Date,templateType:"modal",disableWeekdays:$scope.disabledWeeks};ionicDatePicker.openDatePicker(ipObj1)},$scope.checkPhone=function(){if(void 0!=$scope.dataContainer.phone)if(11==$scope.dataContainer.phone.length){var phone=$scope.dataContainer.phone.toString();if(!/^1(3|4|5|7|8)\d{9}$/.test(phone))return layer.msg("输入的手机号码有误"),$scope.verificationCodeBtnDisabled=!0,$scope.payBtnDisabled=!0,!1;$scope.verificationCodeBtnDisabled=!1}else $scope.verificationCodeBtnDisabled=!0,$scope.payBtnDisabled=!0};var defaultCountdown=60;$scope.countdownTime=defaultCountdown;var stopCountdownTime;$scope.fight=function(){$scope.countdownTxtShow=!0,angular.isDefined(stopCountdownTime)||(stopCountdownTime=$interval(function(){$scope.countdownTime>0?$scope.countdownTime=$scope.countdownTime-1:($scope.stopFight(),$scope.countdownTxtShow=!1,$scope.verificationCodeBtnDisabled=!1,$scope.resetFight())},1e3))},$scope.stopFight=function(){angular.isDefined(stopCountdownTime)&&($interval.cancel(stopCountdownTime),stopCountdownTime=void 0)},$scope.resetFight=function(){$scope.countdownTime=defaultCountdown},$scope.$on("$destroy",function(){$scope.stopFight()
}),$scope.countdown=function(){var departDate=$filter("date")($scope.currentSelectedDateOrTime,"yyyy-MM-dd"),checkcode=parseInt($scope.dataContainer.phone)%parseInt($scope.dataContainer.phone.substring(1,4));if(null!=$scope.ticketInfo.plans){if(null!=$scope.ticketInfo.plans[0]&&null==$scope.ticketInfo.plans[1]){if(1!=$scope.ticketInfo_forwardTicket_haveChoosed)return layer.open({content:"请先选择出发时间",btn:"确定"}),!1;var bsids=$scope.ticketInfo.plans[0].linename+"&"+departDate+"&"+$scope.ticketInfo_forwardTicket_time,requestData={phone:$scope.dataContainer.phone,servicename:"UserBuyViewTicket",checkcode:checkcode.toString(),bsids:bsids}}else if(null!=$scope.ticketInfo.plans[0]&&null!=$scope.ticketInfo.plans[1]){if(1!=$scope.ticketInfo_forwardTicket_haveChoosed||1!=$scope.ticketInfo_backwardTicket_haveChoosed)return layer.open({content:"请先选择出发时间",btn:"确定"}),!1;var bsids=$scope.ticketInfo.plans[0].linename+"&"+departDate+"&"+$scope.ticketInfo_forwardTicket_time,requestData={phone:$scope.dataContainer.phone,servicename:"UserBuyViewTicket",checkcode:checkcode.toString(),bsids:bsids}}}else var tickets=$scope.ticketInfo.viewInfo.viewName+"&"+departDate,requestData={phone:$scope.dataContainer.phone,servicename:"UserBuyDoorTicket",checkcode:checkcode.toString(),tickets:tickets};$scope.verificationCodeBtnDisabled=!0,console.log("订单页：电话号码 "+$scope.dataContainer.phone),$scope.fight(),console.log("订单页：验证码请求参数"),console.log(requestData),$myHttpService.postNoLoad("api/utils/sendCheckAuthcode",requestData,function(data){console.log("订单页：获取短信验证码API返回的数据"),console.log(data)})},$scope.couponChooseModal=$ionicModal.fromTemplate('<ion-modal-view>	          <ion-header-bar class="bar bar-header modal-two" >				   <button class="button  button-balanced" ng-click="coupon_NOFn()" style="background: rgba(240, 248, 255, 0.09);color: #676464;">取消</button>          <h1 class="title" style="color: black;font-size: 17px;font-weight: 400;">请选择优惠券</h1>          <button class="button button-balanced" ng-click="coupon_OKFn()" style="background: rgba(240, 248, 255, 0.09);color: #676464;">确定</button>		        </ion-header-bar>		        <ion-content class="padding" style="background: #ffffff;margin-top: 300px;" >			<ion-radio style="padding: 15px 10px;border: none;font-size: 17px;" ng-repeat="item in couponArr"               ng-value="item.brcid"               ng-model="couponType.type">      			{{ item.couponMoney }} 元 <span style="margin-left: 5px;">有效期 {{item.overDate | date:"yyyy-MM-dd"}}</span>     		</ion-radio>			        </ion-content>		      </ion-modal-view>',{scope:$scope,animation:"slide-in-up"}),$scope.useCoupon=!1,$scope.noCouponTxt=!1,$scope.noCouponTxt2=!1,$scope.noCouponTxt3=!0,$scope.couponType={type:""},$scope.checkCoupon2=function(){$myHttpService.post("api/product/queryUserBuslineCoupon",{userid:$rootScope.session.user.userInfo.userid},function(data){console.log("订单页：查询用户是否有优惠卷API返回的数据"),console.log(data),data.isHaveCoupon?($scope.couponArr=data.buslineCoupons,null==$scope.couponArr[0]?($scope.noCouponTxt=!0,$scope.noCouponTxt3=!1,$scope.useCoupon=!1):($scope.couponType={type:$scope.couponArr[0].brcid},$scope.couponChooseModal.show())):($scope.noCouponTxt=!0,$scope.noCouponTxt3=!1,$scope.useCoupon=!1)})},$scope.coupon_OKFn=function(){for(var item in $scope.couponArr){var objTemp=$scope.couponArr[item];objTemp.brcid==$scope.couponType.type&&($scope.coupon=objTemp.couponMoney,$scope.noCouponTxt2=!0,$scope.noCouponTxt3=!1,$scope.useCoupon=!0)}console.log("订单页：优惠券类型"),console.log($scope.couponType.type),$scope.couponChooseModal.hide()},$scope.coupon_NOFn=function(){$scope.couponType.type="",$scope.coupon=0,$scope.useCoupon=!1,$scope.noCouponTxt=!1,$scope.noCouponTxt2=!1,$scope.noCouponTxt3=!0,console.log("订单页：优惠券类型"),console.log($scope.couponType.type),$scope.couponChooseModal.hide()},$scope.$on("$destroy",function(){$scope.couponChooseModal.remove()}),$scope.payBtnCheck=function(){if(void 0!=$scope.dataContainer.phone)if(11==$scope.dataContainer.phone.length){var phone=$scope.dataContainer.phone.toString();if(!/^1(3|4|5|7|8)\d{9}$/.test(phone))return layer.msg("输入的手机号码有误"),$scope.checkPhoneState=!1,!1;$scope.checkPhoneState=!0}else $scope.checkPhoneState=!1;else $scope.checkPhoneState=!1;$scope.payBtnDisabled=$scope.checkPhoneState&&$scope.dataContainer.verificationCode?!1:!0},$scope.recharge=function(){if(null==$scope.ticketInfo.plans&&null!=$scope.ticketInfo.viewInfo){for(var flag=!1,i=0;i<$scope.ticketInfo_viewInfo_tempRequestParamArr.length;i++)if(void 0!=$scope.ticketInfo_viewInfo_tempRequestParamArr[i]){var item=$scope.ticketInfo_viewInfo_tempRequestParamArr[i][1];0!=item&&(flag=!0)}if(0==flag)return layer.open({content:"客官，请至少选择一张门票 (╯-╰)",btn:"确定"}),!1}if(null!=$scope.ticketInfo.plans&&null!=$scope.ticketInfo.viewInfo){if(null!=$scope.ticketInfo.plans[0]&&null==$scope.ticketInfo.plans[1]&&0==$scope.ticketInfo_forwardTicket_count){for(var flag2=!1,i=0;i<$scope.ticketInfo_viewInfo_tempRequestParamArr.length;i++)if(void 0!=$scope.ticketInfo_viewInfo_tempRequestParamArr[i]){var item=$scope.ticketInfo_viewInfo_tempRequestParamArr[i][1];0!=item&&(flag2=!0)}if(0==flag2)return layer.open({content:"客官，请至少选择一张门票 (╯-╰)",btn:"确定"}),!1}if(null!=$scope.ticketInfo.plans[0]&&null!=$scope.ticketInfo.plans[1]&&0==$scope.ticketInfo_forwardTicket_count&&0==$scope.ticketInfo_backwardTicket_count){for(var flag3=!1,i=0;i<$scope.ticketInfo_viewInfo_tempRequestParamArr.length;i++)if(void 0!=$scope.ticketInfo_viewInfo_tempRequestParamArr[i]){var item=$scope.ticketInfo_viewInfo_tempRequestParamArr[i][1];0!=item&&(flag3=!0)}if(0==flag3)return layer.open({content:"客官，请至少选择一张门票 (╯-╰)",btn:"确定"}),!1}}var bdids="";if(null!=$scope.ticketInfo_Ticket_tempRequestParamArr)for(var i=0,len=$scope.ticketInfo_Ticket_tempRequestParamArr.length;len>i;i++)bdids+=i==len-1?$scope.ticketInfo_Ticket_tempRequestParamArr[i][0]+"&"+$scope.ticketInfo_Ticket_tempRequestParamArr[i][1]:$scope.ticketInfo_Ticket_tempRequestParamArr[i][0]+"&"+$scope.ticketInfo_Ticket_tempRequestParamArr[i][1]+"&&";var viewPrices="";if(null!=$scope.ticketInfo_viewInfo_tempRequestParamArr)for(var i=0,len=$scope.ticketInfo_viewInfo_tempRequestParamArr.length;len>i;i++)void 0!=$scope.ticketInfo_viewInfo_tempRequestParamArr[i]&&(viewPrices+=i==len-1?$scope.ticketInfo_viewInfo_tempRequestParamArr[i][0]+"&"+$scope.ticketInfo_viewInfo_tempRequestParamArr[i][1]:$scope.ticketInfo_viewInfo_tempRequestParamArr[i][0]+"&"+$scope.ticketInfo_viewInfo_tempRequestParamArr[i][1]+"&&");var departDate=$filter("date")($scope.currentSelectedDateOrTime,"yyyy-MM-dd"),userid=$rootScope.session.user.userInfo.userid,openid=$rootScope.session.user.userInfo.openid,authcode=$scope.dataContainer.verificationCode,productid=$scope.paramsProductid,couponuse=$scope.useCoupon+"",brcid=$scope.couponType.type,data2={departDate:departDate,bdids:bdids,couponuse:couponuse,userid:userid,openid:openid,authcode:authcode,viewPrices:viewPrices,brcid:brcid,productid:productid};data2=formatParamObject(data2),console.log("订单页：支付购买的请求参数"),console.log(data2);var data3_count="",data3_backCount="",data3_gobdid="",data3_backbdid="",data3_doorCount="",data3_viewid="";if(null!=$scope.ticketInfo.viewInfo&&(data3_viewid=$scope.ticketInfo.viewInfo.viewid),null!=$scope.ticketInfo_Ticket_tempRequestParamArr)for(var i=0,len=$scope.ticketInfo_Ticket_tempRequestParamArr.length;len>i;i++)0==i?(data3_gobdid=$scope.ticketInfo_Ticket_tempRequestParamArr[i][0],data3_count=$scope.ticketInfo_Ticket_tempRequestParamArr[i][1]):1==i&&(data3_backbdid=$scope.ticketInfo_Ticket_tempRequestParamArr[i][0],data3_backCount=$scope.ticketInfo_Ticket_tempRequestParamArr[i][1]);if(null!=$scope.ticketInfo_viewInfo_tempRequestParamArr){data3_doorCount=0;for(var i=0;i<$scope.ticketInfo_viewInfo_tempRequestParamArr.length;i++)void 0!=$scope.ticketInfo_viewInfo_tempRequestParamArr[i]&&(data3_doorCount+=Number.parseInt($scope.ticketInfo_viewInfo_tempRequestParamArr[i][1]))}var data3={userid:userid,departDate:departDate,gobdid:data3_gobdid,backbdid:data3_backbdid,count:data3_count,backCount:data3_backCount,doorCount:data3_doorCount,viewid:data3_viewid};console.log("订单页：传递到支付成功页的参数"),console.log(data3),$myHttpService.post("api/product/buyProductTicket",data2,function(data){function onBridgeReady(){WeixinJSBridge.invoke("getBrandWCPayRequest",wxData,function(res){"get_brand_wcpay_request:ok"==res.err_msg?$myHttpService.post("api/recharge/verifyWxorderStatus",{rechargeid:$scope.rechargeid},function(){alert("您已成功支付"),console.log("订单页：微信支付成功，传递到支付成功页的参数"),console.log(data3),$state.go("order_detail_refund",{data:JSON.stringify(data3)},{reload:!0})},function(){layer.open({content:"支付失败，请联系客服处理。",btn:"确定"})}):layer.open("get_brand_wcpay_request:cancel"==res.err_msg?{content:"你取消了本次支付",btn:"确定"}:{content:"支付失败，请联系客服处理。",btn:"确定"})})}if(console.log("订单页：支付请求API返回的数据"),console.log(data),null!=data.counponUse)data.updateCoupon?(console.log("订单页：优惠券支付成功，传递到支付成功页的参数"),console.log(data3),$state.go("order_detail_refund",{data:JSON.stringify(data3)},{reload:!0})):layer.open({content:"支付失败",btn:"确定"});else{$scope.rechargeid=data.rechargeid;var wxData={appId:data.appId,timeStamp:data.timeStamp,nonceStr:data.nonceStr,"package":data.package,signType:data.signType,paySign:data.paySign};"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",onBridgeReady,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",onBridgeReady),document.attachEvent("onWeixinJSBridgeReady",onBridgeReady)):onBridgeReady()}})},$scope.checkRecharge=function(){if(null!=$scope.ticketInfo.plans){if(console.log("1"),null!=$scope.ticketInfo.plans[0]&&(console.log("2"),0==$scope.ticketInfo_forwardTicket_haveChoosed))return layer.open({content:"客官，请选择行程出发时间日期 (╯-╰)",btn:"确定"}),!1;if(null!=$scope.ticketInfo.plans[1]&&(console.log("3"),0==$scope.ticketInfo_backwardTicket_haveChoosed))return layer.open({content:"客官，请选择行程出发时间日期 (╯-╰)",btn:"确定"}),!1;if(null!=$scope.ticketInfo.plans[0]&&null==$scope.ticketInfo.plans[1]&&(console.log("4"),0==$scope.ticketInfo_forwardTicket_count))return console.log("4-1"),layer.open({content:"您购买的订单中不包含车票，是否继续？",btn:["继续","取消"],shadeClose:!1,yes:function(index){$scope.recharge(),layer.close(index)}}),!1;if(null!=$scope.ticketInfo.plans[0]&&null!=$scope.ticketInfo.plans[1]&&(console.log("5"),0==$scope.ticketInfo_forwardTicket_count&&0==$scope.ticketInfo_backwardTicket_count))return console.log("5-1"),layer.open({content:"您购买的订单中不包含车票，是否继续？",btn:["继续","取消"],shadeClose:!1,yes:function(index){$scope.recharge(),layer.close(index)}}),!1}console.log("调用了"),$scope.recharge()},$scope.yonghuxuzhi_Fn=function(){layer.open({type:1,content:'<p style="text-align: right;margin-top: 10px;"><i class="icon ion-ios-close-empty" style="color:#ccc;font-size: 45px;margin-right: 10px;" onclick="layer.closeAll();"></i></p><div style="margin: 5px 15px;">'+$scope.ticketInfo.productinfo+"</div>",anim:"up",style:"position: absolute; left:0; top:0; width:100%; height:100%; border: none; -webkit-animation-duration: .3s; animation-duration: .3s;background: white;"})}}).controller("order_detail_refund",function($rootScope,$scope,$filter,$state,$myHttpService,$ionicSlideBoxDelegate){if($scope.ticketsInfo=[],$scope.ticketsViewInfo=[],null==JSON.parse($state.params.data))$scope.ticketsInfo=getStorageData("jqztc_zfcgy_ticketsInfo"),$scope.ticketsViewInfo=getStorageData("jqztc_zfcgy_ticketsViewInfo"),$ionicSlideBoxDelegate.update();else{$scope.ticketsInfoTemp=[];var paramsData=JSON.parse($state.params.data);paramsData=formatParamObject(paramsData),console.log("支付成功页：请求参数"),console.log(paramsData),$myHttpService.post("api/product/queryProductOrderByBdid",paramsData,function(data){console.log("支付成功页：获取用户刚刚购买的票API返回的数据"),console.log(data),null!=data.viewOrders&&0!=data.viewOrders.length&&($scope.ticketsInfo=data.viewOrders,console.log($scope.ticketsInfo)),null!=data.backViewOrders&&0!=data.backViewOrders.length&&($scope.ticketsInfo=$scope.ticketsInfo.concat(data.backViewOrders)),console.log("支付成功页: 车票数组"),console.log($scope.ticketsInfo),null!=data.ticketOrders&&0!=data.ticketOrders.length&&($scope.ticketsViewInfo=data.ticketOrders),console.log("支付成功页: 合并之后的门票数组"),console.log($scope.ticketsViewInfo),$ionicSlideBoxDelegate.update(),storageData("jqztc_zfcgy_ticketsInfo",$scope.ticketsInfo),storageData("jqztc_zfcgy_ticketsViewInfo",$scope.ticketsViewInfo)},errorFn)}$scope.getBusPosition=function(item){var data={carid:item.carid,lineid:item.lineid};$state.go("ticket_detail.bus_position",{data:JSON.stringify(data)},{reload:!1})}}).controller("myplan",function($rootScope,$scope,$filter,$myHttpService,$state,$timeout,$ionicTabsDelegate){if($rootScope.jqztc_xdxcy_current_tab_index&&(0==$rootScope.jqztc_xdxcy_current_tab_index?$timeout(function(){$ionicTabsDelegate.select(0)},50):1==$rootScope.jqztc_xdxcy_current_tab_index?$timeout(function(){$ionicTabsDelegate.select(1)},50):2==$rootScope.jqztc_xdxcy_current_tab_index&&$timeout(function(){$ionicTabsDelegate.select(2)},50)),null==sessionStorage.getItem("myplanCount"))var myplanCount=1;else var myplanCount=sessionStorage.getItem("myplanCount");$scope.ticketsInfoIsEmpty=!1,$scope.jqztc_xdxcy_ticketsInfo_nouse_ticketsInfoIsEmpty=!1,$scope.jqztc_xdxcy_ticketsInfo_refund_ticketsInfoIsEmpty=!1,1==myplanCount&&($rootScope.jqztc_xdxcy_ticketsInfo=[],$rootScope.jqztc_xdxcy_ticketsViewInfo=[],$rootScope.jqztc_xdxcy_ticketsInfo_nouse=[],$rootScope.jqztc_xdxcy_ticketsViewInfo_nouse=[],$rootScope.jqztc_xdxcy_ticketsInfo_refund=[],$rootScope.jqztc_xdxcy_ticketsViewInfo_refund=[],sessionStorage.setItem("myplanCount",2),$rootScope.hasmore2=!1,$rootScope.jqztc_xdxcy_current_tab_index=0);var run=!1;$scope.tab_all=function(){console.log("我的行程页：tab_all执行"),$rootScope.jqztc_xdxcy_current_tab_index=$ionicTabsDelegate.selectedIndex(),console.log("我的行程页：当前索引"),console.log($rootScope.jqztc_xdxcy_current_tab_index);var requestData={userid:$rootScope.session.user.userInfo.userid,offset:0,pagesize:15};$myHttpService.post("api/product/queryUserProductTicketList",requestData,function(data){console.log("我的行程页：获取所有订单的列表API返回的数据"),console.log(data),$rootScope.jqztc_xdxcy_ticketsInfo=data.userViewList,$rootScope.jqztc_xdxcy_ticketsViewInfo=data.ticketOrders,$scope.$broadcast("scroll.refreshComplete"),console.log("我的行程页：全部车票数组"),console.log($rootScope.jqztc_xdxcy_ticketsInfo),console.log("我的行程页：全部门票数组"),console.log($rootScope.jqztc_xdxcy_ticketsViewInfo),0==$rootScope.jqztc_xdxcy_ticketsInfo.length&&0==$rootScope.jqztc_xdxcy_ticketsViewInfo.length&&$timeout(function(){$scope.ticketsInfoIsEmpty=!0},700),data.userViewList.length+data.ticketOrders.length<15?$rootScope.hasmore2=!1:($rootScope.hasmore2=!0,$scope.pageCount=2)},function(){$scope.$broadcast("scroll.refreshComplete")})},$scope.refresh_tab_all=function(){console.log("我的行程页：doRefreshTicket执行");var requestData={userid:$rootScope.session.user.userInfo.userid,offset:0,pagesize:15};$myHttpService.postNoLoad("api/product/queryUserProductTicketList",requestData,function(data){console.log("我的行程页：获取所有订单的列表API返回的数据(下拉刷新)"),console.log(data),$rootScope.jqztc_xdxcy_ticketsInfo=data.userViewList,$rootScope.jqztc_xdxcy_ticketsViewInfo=data.ticketOrders,$scope.$broadcast("scroll.refreshComplete"),console.log("我的行程页：全部车票数组"),console.log($rootScope.jqztc_xdxcy_ticketsInfo),console.log("我的行程页：全部门票数组"),console.log($rootScope.jqztc_xdxcy_ticketsViewInfo),0==$rootScope.jqztc_xdxcy_ticketsInfo.length&&0==$rootScope.jqztc_xdxcy_ticketsViewInfo.length?$timeout(function(){$scope.ticketsInfoIsEmpty=!0},700):layer.open({content:"刷新成功",skin:"msg",time:1}),data.userViewList.length+data.ticketOrders.length<15?$rootScope.hasmore2=!1:($rootScope.hasmore2=!0,$scope.pageCount=2)},function(){$scope.$broadcast("scroll.refreshComplete")})};var compare=function(prop){return function(obj1,obj2){var val1=obj1[prop],val2=obj2[prop];return void 0==val1&&(val1=1e5),void 0==val2&&(val2=1e5),isNaN(Number(val1))||isNaN(Number(val2))||(val1=Number(val1)/1e4,val2=Number(val2)/1e4),val2-val1}};$scope.load_more_tab_all=function(){console.log("我的行程页：load_more_tab_all执行");var offset=15*($scope.pageCount-1),requestData={userid:$rootScope.session.user.userInfo.userid,offset:offset,pagesize:15};run||(run=!0,$myHttpService.postNoLoad("api/product/queryUserProductTicketList",requestData,function(data){console.log("我的行程页：获取所有订单的列表API返回的数据(上拉加载)"),console.log(data),$rootScope.jqztc_xdxcy_ticketsInfo=$rootScope.jqztc_xdxcy_ticketsInfo.concat(data.userViewList),$rootScope.jqztc_xdxcy_ticketsViewInfo=$rootScope.jqztc_xdxcy_ticketsViewInfo.concat(data.ticketOrders),console.log("我的行程页：全部车票数组"),console.log($rootScope.jqztc_xdxcy_ticketsInfo),console.log("我的行程页：全部门票数组"),console.log($rootScope.jqztc_xdxcy_ticketsViewInfo),$rootScope.jqztc_xdxcy_ticketsInfo.sort(compare("departDate")),$scope.$broadcast("scroll.infiniteScrollComplete"),0==$rootScope.jqztc_xdxcy_ticketsInfo.length&&0==$rootScope.jqztc_xdxcy_ticketsViewInfo.length?$timeout(function(){$scope.ticketsInfoIsEmpty=!0},700):layer.open({content:"加载成功",skin:"msg",time:1}),data.userViewList.length+data.ticketOrders.length<15?($scope.hasmore=!1,$rootScope.hasmore2=!1):$scope.pageCount++,run=!1},function(){$scope.$broadcast("scroll.infiniteScrollComplete")}))},$scope.tab_nouse=function(){console.log("我的行程页：tab_nouse执行"),$rootScope.jqztc_xdxcy_current_tab_index=$ionicTabsDelegate.selectedIndex(),console.log("我的行程页：当前索引"),console.log($rootScope.jqztc_xdxcy_current_tab_index);var requestData={userid:$rootScope.session.user.userInfo.userid,viewOrderStatus:2,offset:0,pagesize:20};$myHttpService.post("api/product/queryUserProductTicketList",requestData,function(data){console.log("我的行程页：获取未使用订单的列表API返回的数据"),console.log(data),data.userViewList.length+data.ticketOrders.length<20?$rootScope.jqztc_xdxcy_ticketsInfo_nouse_hasmore2=!1:($rootScope.jqztc_xdxcy_ticketsInfo_nouse_hasmore2=!0,$scope.jqztc_xdxcy_ticketsInfo_nouse_pageCount=2),$rootScope.jqztc_xdxcy_ticketsInfo_nouse=data.userViewList,$rootScope.jqztc_xdxcy_ticketsViewInfo_nouse=data.ticketOrders,$scope.$broadcast("scroll.refreshComplete"),console.log("我的行程页：未使用车票数组"),console.log($rootScope.jqztc_xdxcy_ticketsInfo_nouse),console.log("我的行程页：未使用门票数组"),console.log($rootScope.jqztc_xdxcy_ticketsViewInfo_nouse),0==$rootScope.jqztc_xdxcy_ticketsInfo_nouse.length&&0==$rootScope.jqztc_xdxcy_ticketsViewInfo_nouse.length&&$timeout(function(){$scope.jqztc_xdxcy_ticketsInfo_nouse_ticketsInfoIsEmpty=!0},700)},function(){$scope.$broadcast("scroll.refreshComplete")})},$scope.tab_refund=function(){console.log("我的行程页：tab_refund执行"),$rootScope.jqztc_xdxcy_current_tab_index=$ionicTabsDelegate.selectedIndex(),console.log("我的行程页：当前索引"),console.log($rootScope.jqztc_xdxcy_current_tab_index);var requestData={userid:$rootScope.session.user.userInfo.userid,viewOrderStatus:4,offset:0,pagesize:20};$myHttpService.post("api/product/queryUserProductTicketList",requestData,function(data){console.log("我的行程页：获取正在退款中订单的列表API返回的数据"),console.log(data),data.userViewList.length+data.ticketOrders.length<20?$rootScope.jqztc_xdxcy_ticketsInfo_refund_hasmore2=!1:($rootScope.jqztc_xdxcy_ticketsInfo_refund_hasmore2=!0,$scope.jqztc_xdxcy_ticketsInfo_refund_pageCount=2),$rootScope.jqztc_xdxcy_ticketsInfo_refund=data.userViewList,$rootScope.jqztc_xdxcy_ticketsViewInfo_refund=data.ticketOrders,$scope.$broadcast("scroll.refreshComplete"),console.log("我的行程页：未使用车票数组"),console.log($rootScope.jqztc_xdxcy_ticketsInfo_refund),console.log("我的行程页：未使用门票数组"),console.log($rootScope.jqztc_xdxcy_ticketsViewInfo_refund),0==$rootScope.jqztc_xdxcy_ticketsInfo_refund.length&&0==$rootScope.jqztc_xdxcy_ticketsViewInfo_refund.length&&$timeout(function(){$scope.jqztc_xdxcy_ticketsInfo_refund_ticketsInfoIsEmpty=!0},700)},function(){$scope.$broadcast("scroll.refreshComplete")})},$scope.unusedTicketToDetail=function(item,i,$event){console.log("我的行程页：当前元素的位置"),console.log($event),$state.go("ticket_detail.ticketdetail",{data:JSON.stringify(item)},{reload:!1})},$scope.usedTicketToComment=function(item){layer.open({type:2,content:"加载中"});var isCommented=!1,isCommentedText="",isCommentedScore=1;null!=item.orderhie&&(isCommented=!0,isCommentedText=item.orderhie,isCommentedScore=item.orderScore),$state.go("order_check_comment",{data:JSON.stringify(item),isCommented:JSON.stringify(isCommented),isCommentedText:JSON.stringify(isCommentedText),isCommentedScore:JSON.stringify(isCommentedScore)},{reload:!0}),layer.closeAll()},$scope.refundingToRefund=function(item){$state.go("ticket_detail.ticketdetail",{data:JSON.stringify(item)},{reload:!1})},$scope.unusedAdmissionTicketToDetail=function(item){$state.go("ticket_admission_detail",{data:JSON.stringify(item)},{reload:!1})}}).controller("test",function($rootScope,$scope,$state,$timeout,$myLocationService,$myHttpService,$ionicLoading,$ionicScrollDelegate,$ionicActionSheet,$selectCity,$filter,ionicDatePicker){$scope.selectedDate1,$scope.selectedDate2,$scope.openDatePickerOne=function(){var ipObj1={callback:function(val){console.log("Return value from the datepicker popup is : "+val,new Date(val)),$scope.selectedDate1=new Date(val)},from:new Date,to:new Date(2099,11,31),inputDate:new Date,titleLabel:"选择日期",setLabel:"选择",todayLabel:"今天",closeLabel:"返回",mondayFirst:!1,disableWeekdays:[],dateFormat:"yyyy-MM-dd",closeOnSelect:!1,templateType:"popup"};ionicDatePicker.openDatePicker(ipObj1)},$scope.openDatePickerTwo=function(){var ipObj1={callback:function(val){console.log("Return value from the datepicker modal is : "+val,new Date(val)),$scope.selectedDate2=new Date(val)},titleLabel:"选择日期",closeLabel:"返回",from:new Date,to:new Date(2099,11,31),dateFormat:"yyyy-MM-dd",closeOnSelect:!0,inputDate:new Date,templateType:"modal"};ionicDatePicker.openDatePicker(ipObj1)},$scope.$on("$destroy",function(){});$scope.thumb={},$scope.getGuid=function(){function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()},$scope.chooseImg=function($event){console.log($event),wx.chooseImage({count:2,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(res){for(var localIds=res.localIds,i=0;i<localIds.length;i++){var guid=$scope.getGuid();$scope.$apply(function(){$scope.thumb[guid]={guid:guid}})}},fail:function(res){alterShowMessage("操作提示",JSON.stringify(res),"1","确定","","","")}})}}).controller("BusPositionController",function($scope,$myHttpService,$timeout,$state){if(null==JSON.parse($state.params.data)){var lineArr=[116.397428,39.90923],map=new AMap.Map("J_map_canvas",{resizeEnable:!0,center:[lineArr[0],lineArr[1]],zoom:17});marker=new AMap.Marker({map:map,position:[lineArr[0],lineArr[1]],icon:"http://webapi.amap.com/images/car.png",content:'<i class="icon ion-ios-location" style="color: #f71909;font-size:30px"></i>',offset:new AMap.Pixel(-26,-13),animation:"AMAP_ANIMATION_DROP"}),$timeout(function(){layer.open({content:"请求车辆位置出错，请重试",btn:"确定",shadeClose:!1,yes:function(index){$state.go("myplan",{},{location:"replace"}),layer.close(index)}})},1500)}else{var paramsData=JSON.parse($state.params.data);console.log("车辆位置页：传到定位地图页面的参数"),console.log(paramsData),$scope.positionArr={},$myHttpService.post("api/product/queryCarLocation",{carid:paramsData.carid,lineid:paramsData.lineid},function(data){console.log("车辆位置页：查询车辆位置API返回的数据"),console.log(data),$scope.positionArr=data.car,$scope.busline=data.busline,$scope.stations=data.stations;var lineArr=[$scope.positionArr.currlon,$scope.positionArr.currlat],map=new AMap.Map("J_map_canvas",{resizeEnable:!0,center:[lineArr[0],lineArr[1]],zoom:11}),allLonLatArr=[],stationType1=[];for(var index in $scope.stations){var item=$scope.stations[index],tempArr=[item.stalongitude,item.stalatitude];if(allLonLatArr.push(tempArr),1==item.stationType){var tempArr2=[[item.stalongitude,item.stalatitude],item.stationname];stationType1.push(tempArr2)}}var startPositionLonLat=[$scope.busline.departlon,$scope.busline.departlat],endPositionLonLat=[$scope.busline.arrivelon,$scope.busline.arrivelat],allLonLatArr2=allLonLatArr.slice(1,allLonLatArr.length-1);AMapUI.load(["ui/overlay/SimpleMarker"],function(SimpleMarker){AMap.plugin("AMap.Driving",function(){var drving=new AMap.Driving({map:map,hideMarkers:!0});drving.search(startPositionLonLat,endPositionLonLat,{waypoints:allLonLatArr2},function(){for(var index in stationType1){var item=stationType1[index];new SimpleMarker(0==index?{iconLabel:{innerHTML:"起",style:{color:"#fff",fontSize:"120%",marginTop:"2px"}},iconStyle:"green",map:map,position:item[0],label:{content:item[1],offset:new AMap.Pixel(11,43)}}:index==stationType1.length-1?{iconLabel:{innerHTML:"终",style:{color:"#fff",fontSize:"120%",marginTop:"2px"}},iconStyle:"red",map:map,position:item[0],label:{content:item[1],offset:new AMap.Pixel(11,43)}}:{iconLabel:{innerHTML:"经",style:{color:"#fff",fontSize:"120%",marginTop:"2px"}},iconStyle:"orange",map:map,position:item[0],label:{content:item[1],offset:new AMap.Pixel(11,43)}})}})})}),$timeout(function(){new AMap.Marker({map:map,position:[lineArr[0],lineArr[1]],content:'<i class="icon ion-ios-location" style="color: #f71909;font-size:30px"></i>',animation:"AMAP_ANIMATION_DROP"}),new AMap.Circle({map:map,center:[lineArr[0],lineArr[1]],redius:100,fillOpacity:.1,fillColor:"#09f",strokeColor:"#09f",strokeWeight:1});AMap.plugin("AMap.Geocoder",function(){var str="加载中>>>",geocoder=new AMap.Geocoder({});geocoder.getAddress([lineArr[0],lineArr[1]],function(status,result){if("complete"==status){str=result.regeocode.formattedAddress;var info=new AMap.InfoWindow({content:'<div class="title_bus_position">当前车辆位置</div><div class="content_bus_position">'+str+"<br/></div>",offset:new AMap.Pixel(0,-28),size:new AMap.Size(200,0)});info.open(map,[lineArr[0],lineArr[1]])}})})},1500)},errorFn)}}).controller("ticket_detail",function($rootScope,$scope,$filter,$interval,$timeout,$myHttpService,$state){function ShowCountDown(endTime){var now=new Date,leftTime=endTime-now.getTime();if(leftTime>0){var leftsecond=parseInt(leftTime/1e3);$scope.day=Math.floor(leftsecond/86400),$scope.hour=Math.floor((leftsecond-24*$scope.day*60*60)/3600),$scope.minute=Math.floor((leftsecond-24*$scope.day*60*60-3600*$scope.hour)/60),$scope.second=Math.floor(leftsecond-24*$scope.day*60*60-3600*$scope.hour-60*$scope.minute)}else clearInterval(stopCountDown),$scope.timeText="",$scope.timeShow=!1}$scope.timeShow=!1,$scope.timeText="距离发车时间还剩",$scope.lunXunTimer=null,$scope.isCheckedTicket=!1;var stopCountDown=null;if(null==JSON.parse($state.params.data)){var viewOrderid=sessionStorage.getItem("jqztc_cpxqy_viewOrderid");$myHttpService.post("api/product/queryUserProductTicketDetails",{viewOrderid:viewOrderid},function(data){console.log("车票详情页：查询订单详情API返回的数据"),console.log(data),$scope.ticketInfo=data.viewOrder,$scope.viewOrderid=$scope.ticketInfo.viewOrderid,2==$scope.ticketInfo.viewOrderStatus&&(lunXunTimer=$interval(function(){$myHttpService.post("api/product/queryTicketStatus",{viewOrderid:$scope.viewOrderid},function(data){3==data.viewOrderStatus&&($scope.isCheckedTicket=!0)})},15e3)),$scope.refundData=null!=data.viewOrder.rechargeid?{rechargeid:data.viewOrder.rechargeid,userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,viewOrderid:data.viewOrder.viewOrderid,applyResult:!1}:{userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,viewOrderid:data.viewOrder.viewOrderid,applyResult:!1},$timeout(function(){$scope.timeShow=!0},1500);var temp=$filter("date")($scope.ticketInfo.departDate,"yyyy/MM/dd")+" "+$scope.ticketInfo.departTime,endTime=new Date(temp).getTime();stopTime=$interval(function(){ShowCountDown(endTime)},1e3)},errorFn)}else{var paramsData=JSON.parse($state.params.data);console.log("车票详情页：参数打印"),console.log(paramsData);var requestData={viewOrderid:paramsData.viewOrderid};sessionStorage.setItem("jqztc_cpxqy_viewOrderid",paramsData.viewOrderid),$myHttpService.post("api/product/queryUserProductTicketDetails",requestData,function(data){console.log("车票详情页：查询订单详情API返回的数据"),console.log(data),$scope.ticketInfo=data.viewOrder,$scope.viewOrderid=$scope.ticketInfo.viewOrderid,2==$scope.ticketInfo.viewOrderStatus&&(lunXunTimer=$interval(function(){$myHttpService.post("api/product/queryTicketStatus",{viewOrderid:$scope.viewOrderid},function(data){3==data.viewOrderStatus&&($scope.isCheckedTicket=!0)})},15e3)),$scope.refundData=null!=data.viewOrder.rechargeid?{rechargeid:data.viewOrder.rechargeid,userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,viewOrderid:data.viewOrder.viewOrderid,applyResult:!1}:{userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,viewOrderid:data.viewOrder.viewOrderid,applyResult:!1},$timeout(function(){$scope.timeShow=!0},1500);var temp=$filter("date")($scope.ticketInfo.departDate,"yyyy/MM/dd")+" "+$scope.ticketInfo.departTime,endTime=new Date(temp).getTime();stopTime=$interval(function(){ShowCountDown(endTime)},1e3)},errorFn)}$scope.$on("$destroy",function(){$interval.cancel(stopTime),$interval.cancel(lunXunTimer)}),$scope.refundBtnState=!1,$scope.refund=function(){layer.open({content:"您确定要退款吗？",btn:["退款","取消"],shadeClose:!1,yes:function(index){console.log("车票详情页: 退款参数"),console.log($scope.refundData),$myHttpService.post("api/product/applyRefund",$scope.refundData,function(data){console.log("车票详情页: 退款申请API返回的数据"),console.log(data),1==data.counponUse?1==data.couponRefund?($scope.refundBtnState=!0,layer.open({content:"退款成功",btn:"确定",shadeClose:!1,yes:function(index){$state.go("myplan",{},{location:"replace"}),layer.close(index)}})):($scope.refundBtnState=!1,layer.open({content:"申请退款失败，请稍后重试",btn:"确定",shadeClose:!1,yes:function(){}})):($scope.refundBtnState=!0,layer.open({content:"申请退款成功，退款将按原路返回到支付账户，预计到账时间为0-3个工作日",btn:"确定",shadeClose:!1,yes:function(index){$state.go("myplan",{},{location:"replace"}),layer.close(index)}}))},errorFn),layer.close(index)}})},$scope.getBusPosition=function(){var data={carid:$scope.ticketInfo.carid,lineid:$scope.ticketInfo.lineid};$state.go("ticket_detail.bus_position",{data:JSON.stringify(data)},{reload:!0})}}).controller("order_check_comment",function($rootScope,$scope,$timeout,$state,$filter,$myHttpService){if($scope.submitBtnIsDiasbled=!0,null==JSON.parse($state.params.data))$state.go("myplan");else{$scope.isCommented=JSON.parse($state.params.isCommented),$scope.isCommentedText=JSON.parse($state.params.isCommentedText),$scope.isCommentedScore=JSON.parse($state.params.isCommentedScore);var paramsData=JSON.parse($state.params.data);console.log("车票评价页：接收参数"),console.log(paramsData),$scope.ticketInfo=paramsData,$scope.productid=$scope.ticketInfo.productid,$scope.viewOrderid=$scope.ticketInfo.viewOrderid,$scope.dataContainer={text:""},$scope.max=5,$scope.ratingVal=5,$scope.readonly=!1,$scope.onHover=function(val){$scope.ratingVal=val},$scope.onLeave=function(){},$scope.submitBtnCheck=function(){$scope.submitBtnIsDiasbled=$scope.dataContainer.text?!1:!0},$scope.submitComment=function(){var data={productid:$scope.productid,userid:$rootScope.session.user.userInfo.userid,orderScore:$scope.ratingVal,orderhie:$scope.dataContainer.text,orderid:$scope.viewOrderid};console.log("车票评价页：评论提交参数"),console.log(data),$myHttpService.post("api/product/insertViewOrderHierarchy",data,function(){$scope.readonly=!0,$scope.isCommented=!0,$scope.isCommentedText=$scope.dataContainer.text,$scope.isCommentedScore=$scope.ratingVal,layer.open({content:"评价提交成功",btn:"确定",shadeClose:!1,yes:function(index){layer.close(index)}})},errorFn)}}}).controller("admission_ticket_detail",function($rootScope,$scope,$filter,$interval,$myHttpService,$state){$scope.refundBtnState=!1,$scope.isCheckedTicket=!1,$scope.lunXunTimer=null;var paramsData=JSON.parse($state.params.data);console.log("门票详情页：参数打印"),console.log(paramsData),$myHttpService.post("api/ticketorder/queryUserDoorTicketDetails",{orderid:paramsData.orderid},function(data){console.log("门票详情页：查询订单详情API返回的数据"),console.log(data),$scope.ticketViewInfo=data.ticketOrder,$scope.orderid=$scope.ticketViewInfo.orderid,2==$scope.ticketViewInfo.viewOrderStatus&&(lunXunTimer=$interval(function(){$myHttpService.post("api/ticketorder/queryDoorTicketStatus",{orderid:$scope.orderid},function(data){3==data.ticketStatus&&($scope.isCheckedTicket=!0)
})},15e3)),$scope.refundData=null!=data.ticketOrder.rechargeid?{rechargeid:data.ticketOrder.rechargeid,userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,orderid:data.ticketOrder.orderid,applyResult:!1}:{userid:$rootScope.session.user.userInfo.userid,openid:$rootScope.session.user.userInfo.openid,orderid:data.ticketOrder.orderid,applyResult:!1}},errorFn),$scope.refund=function(){layer.open({content:"您确定要退款吗？",btn:["退款","取消"],shadeClose:!1,yes:function(index){console.log("门票详情页: 退款参数"),console.log($scope.refundData),$myHttpService.post("api/ticketorder/applyDoorTicketRefund",$scope.refundData,function(data){console.log("门票详情页: 退款申请API返回的数据"),console.log(data),1==data.counponUse?1==data.couponRefund?($scope.refundBtnState=!0,layer.open({content:"退款成功",btn:"确定",shadeClose:!1,yes:function(index){$state.go("myplan",{},{location:"replace"}),layer.close(index)}})):($scope.refundBtnState=!1,layer.open({content:"申请退款失败，请稍后重试",btn:"确定",shadeClose:!1,yes:function(){}})):($scope.refundBtnState=!0,layer.open({content:"申请退款成功，退款将按原路返回到支付账户，预计到账时间为0-3个工作日",btn:"确定",shadeClose:!1,yes:function(index){$state.go("myplan",{},{location:"replace"}),layer.close(index)}}))},errorFn),layer.close(index)}})},$scope.$on("$destroy",function(){$interval.cancel(lunXunTimer)})}).controller("IUserController",function($rootScope,$scope,$location,$state,$myHttpService){$scope.tempUser={};var tempUser2={};$myHttpService.post("api/user/queryUserinfo",{userid:$rootScope.session.user.userInfo.userid},function(data){data.flag?($scope.user=data.user,$scope.userOther=$scope.user.userid.length>4?$scope.user.userid.substring(0,6)+"*****"+$scope.user.userid.substring($scope.user.userid.length-4):$scope.user.userid.substring(0,6)+"*****",tempUser2=angular.copy($scope.user)):$state.go("auth.login")}),$scope.editMode=!1,$scope.editCance=!1,$scope.editButtonText="设置",$scope.edit=function(){0==$scope.editMode?($scope.editCance=!0,$scope.editMode=!$scope.editMode,$scope.tempUser=angular.copy($scope.user),$scope.editButtonText="保存"):$scope.tempUser.username.length<2||$scope.tempUser.username.length>4||!/^[\u4e00-\u9fa5]{2,4}$/.test($scope.tempUser.username)||11!=$scope.tempUser.phone.length||!/^1(3|4|5|7|8)\d{9}$/.test($scope.tempUser.phone)?$scope.tempUser.username.length>4||$scope.tempUser.username.length<2||!/^[\u4e00-\u9fa5]{2,4}$/.test($scope.tempUser.username)?layer.open({content:"输入的姓名格式有误，长度为2-4个中文",btn:"确定"}):11!=$scope.tempUser.phone.length?layer.open({content:"输入的手机号有误，长度为11个数字",btn:"确定"}):/^1(3|4|5|7|8)\d{9}$/.test($scope.tempUser.phone)||layer.open({content:"输入的手机号格式有误",btn:"确定"}):($scope.editMode=!$scope.editMode,$scope.editButtonText="设置",$scope.editCance=!1,$myHttpService.post("api/user/modifyUserInfo",$scope.tempUser,function(){$scope.user=angular.copy($scope.tempUser)}))},$scope.cancel=function(){$scope.editMode=!1,$scope.editButtonText="设置",$scope.editCance=!1,$scope.user=angular.copy(tempUser2)}});